# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –Ω–∞ –æ—Ç–∑—ã–≤—ã

## üîç –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 038 (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `location`) —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `kuliga_bookings` **–ù–ï –í–ö–õ–Æ–ß–ê–õ–ò–°–¨** –≤ —Å–∏—Å—Ç–µ–º—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Ç–∑—ã–≤—ã.

### –ü—Ä–∏—á–∏–Ω–∞

1. **`src/services/notification-service.js`** - —Ñ—É–Ω–∫—Ü–∏—è `getTrainingsByDate()` –Ω–µ –≤–∫–ª—é—á–∞–ª–∞ `kuliga_bookings` –≤ –∑–∞–ø—Ä–æ—Å
2. **`src/services/review-notification-service.js`** - —Ñ—É–Ω–∫—Ü–∏–∏ `getCompletedTrainingsToday()` –∏ `getTrainingCount()` –Ω–µ –≤–∫–ª—é—á–∞–ª–∏ `kuliga_bookings`

–†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–ª–∏–µ–Ω—Ç—ã, –∑–∞–ø–∏—Å–∞–≤—à–∏–µ—Å—è –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏ —á–µ—Ä–µ–∑ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ 038), –Ω–µ –ø–æ–ª—É—á–∞–ª–∏:
- ‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö (21:00)
- ‚ùå –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (21:00)

### –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö

–û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "chat not found" –∏ "bot was blocked by the user" - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ Telegram API:
- "chat not found" - –∫–ª–∏–µ–Ω—Ç —É–¥–∞–ª–∏–ª –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª –¥–∏–∞–ª–æ–≥
- "bot was blocked by the user" - –∫–ª–∏–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞

**–ù–û** –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –º–Ω–æ–≥–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å —Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. `src/services/notification-service.js`

#### –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ `kuliga_bookings`:

1. **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏:**
   ```sql
   UNION ALL
   -- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏ (kuliga_bookings)
   SELECT 
       kb.id as training_id,
       'individual' as training_type,
       kb.date,
       kb.start_time,
       kb.end_time,
       ...
       'kuliga_natural_slope' as slope_type,
       kb.location
   FROM kuliga_bookings kb
   JOIN clients c ON kb.client_id = c.id
   LEFT JOIN kuliga_instructors ki ON kb.instructor_id = ki.id
   WHERE kb.date = $1
       AND kb.booking_type = 'individual'
       AND kb.status IN ('pending', 'confirmed')
       AND c.telegram_id IS NOT NULL
   ```

2. **–ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏:**
   ```sql
   UNION ALL
   -- –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏ (kuliga_bookings)
   SELECT 
       kb.id as training_id,
       'group' as training_type,
       ...
       'kuliga_natural_slope' as slope_type,
       kb.location
   FROM kuliga_bookings kb
   JOIN clients c ON kb.client_id = c.id
   JOIN kuliga_group_trainings kgt ON kb.group_training_id = kgt.id
   LEFT JOIN kuliga_instructors ki ON kgt.instructor_id = ki.id
   WHERE kb.date = $1
       AND kb.booking_type = 'group'
       AND kb.status IN ('pending', 'confirmed')
       AND c.telegram_id IS NOT NULL
   ```

3. **–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `slope_type = 'kuliga_natural_slope'`
   - –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ `location`:
     - `'kuliga'` ‚Üí "–ë–∞–∑–∞ –æ—Ç–¥—ã—Ö–∞ ¬´–ö—É–ª–∏–≥–∞-–ö–ª—É–±¬ª"
     - `'vorona'` ‚Üí "–í–æ—Ä–æ–Ω–∏–Ω—Å–∫–∏–µ –≥–æ—Ä–∫–∏"

### 2. `src/services/review-notification-service.js`

#### –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ `kuliga_bookings`:

1. **–í —Ñ—É–Ω–∫—Ü–∏—é `getCompletedTrainingsToday()`:**
   ```sql
   UNION ALL
   -- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏
   SELECT 
       kb.client_id,
       NULL as child_id,
       FALSE as is_child,
       c.telegram_id,
       c.full_name as client_name,
       NULL as child_name,
       'individual' as training_type
   FROM kuliga_bookings kb
   JOIN clients c ON kb.client_id = c.id
   WHERE kb.date = $1
       AND kb.booking_type = 'individual'
       AND kb.status IN ('pending', 'confirmed', 'completed')
       AND c.telegram_id IS NOT NULL

   UNION ALL
   -- –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏
   ...
   ```

2. **–í —Ñ—É–Ω–∫—Ü–∏—é `getTrainingCount()`:**
   ```sql
   UNION ALL
   -- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏
   SELECT kb.id
   FROM kuliga_bookings kb
   WHERE kb.client_id = $1
       AND kb.booking_type = 'individual'
       AND kb.date <= CURRENT_DATE
   
   UNION ALL
   -- –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ö—É–ª–∏–≥–∏
   SELECT kb.id
   FROM kuliga_bookings kb
   WHERE kb.client_id = $1
       AND kb.booking_type = 'group'
       AND kb.date <= CURRENT_DATE
   ```

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
   - `src/services/notification-service.js`
   - `src/services/review-notification-service.js`

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
   ```bash
   pm2 restart all
   # –∏–ª–∏
   systemctl restart your-app-name
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:**
   - –î–æ–∂–¥–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ cron (21:00) –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é:
     ```bash
     node src/scripts/send-training-reminders.js
     node src/scripts/send-review-requests.js
     ```
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

## üîç –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö (21:00):**
   - ‚úÖ –í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (–≤–∫–ª—é—á–∞—è –ö—É–ª–∏–≥—É) –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã
   - ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö

2. **–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã (21:00):**
   - ‚úÖ –í—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–≤–∫–ª—é—á–∞—è –ö—É–ª–∏–≥—É) –±—É–¥—É—Ç –Ω–∞–π–¥–µ–Ω—ã
   - ‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

3. **–û—à–∏–±–∫–∏ "chat not found" –∏ "bot was blocked":**
   - –≠—Ç–∏ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –∫–ª–∏–µ–Ω—Ç—ã —É–¥–∞–ª–∏–ª–∏/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞)
   - –ù–æ —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –±–æ–ª—å—à–µ —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫ –¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ `training_sessions` –∏ `individual_training_sessions`
- –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã: —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ `training_sessions` –∏ `individual_training_sessions`
- ‚ùå –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ `kuliga_bookings` –ù–ï –≤–∫–ª—é—á–∞–ª–∏—Å—å

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: –≤—Å–µ —Ç–∏–ø—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–≤–∫–ª—é—á–∞—è `kuliga_bookings`)
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Ç–∑—ã–≤—ã: –≤—Å–µ —Ç–∏–ø—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–≤–∫–ª—é—á–∞—è `kuliga_bookings`)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è (–ö—É–ª–∏–≥–∞/–í–æ—Ä–æ–Ω–∏–Ω—Å–∫–∏–µ –≥–æ—Ä–∫–∏)

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

–û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "chat not found" –∏ "bot was blocked by the user" - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ Telegram API. –û–Ω–∏ –æ–∑–Ω–∞—á–∞—é—Ç, —á—Ç–æ:
- –ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–∏–ª –±–æ—Ç–∞
- –ö–ª–∏–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞
- –ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—á–∏–Ω–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º

**–≠—Ç–∏ –æ—à–∏–±–∫–∏ –ù–ï —è–≤–ª—è—é—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–æ–π —Å–∏—Å—Ç–µ–º—ã** - –æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –Ω–æ Telegram API —Å–æ–æ–±—â–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–æ–æ–±—â–µ –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å** - —Ç–µ–ø–µ—Ä—å —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ.

