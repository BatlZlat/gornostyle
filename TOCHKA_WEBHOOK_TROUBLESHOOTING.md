# üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –≤–µ–±—Ö—É–∫–∞ –¢–æ—á–∫–∞ –ë–∞–Ω–∫

## –ü—Ä–æ–±–ª–µ–º–∞
```
HTTP 400: {"code":"400","message":"Failed to test webhook url accessibility"}
```

–ë–∞–Ω–∫ –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ callback URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.

---

## ‚úÖ –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞:**
   - `https://enter.tochka.com/uapi/webhook/v1.0/{client_id}` ‚úÖ

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞:**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö payload
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤
   - –£–ª—É—á—à–µ–Ω–∞ –¥–µ—Ç–µ–∫—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üîç –®–∞–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ URL –∏–∑–≤–Ω–µ

–í—ã–ø–æ–ª–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ curl
curl -v https://gornostyle72.ru/api/kuliga/payment/callback

# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å HTTP 200 OK
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS –∏ –ø–æ—Ä—Ç–∞

**–í–∞–∂–Ω–æ:** –ë–∞–Ω–∫ —Ç—Ä–µ–±—É–µ—Ç HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 443.

–ü—Ä–æ–≤–µ—Ä—å:
- ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω
- ‚úÖ –ü–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç
- ‚úÖ Nginx/–ø—Ä–æ–∫—Å–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞ –±–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:

```bash
# PM2 –ª–æ–≥–∏
pm2 logs gornostyle --lines 50

# –ò–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ `/api/kuliga/payment/callback`
- –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 200)
- –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ firewall

```bash
# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç
sudo ufw status
sudo iptables -L -n | grep 443

# –ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç - –æ—Ç–∫—Ä–æ–π:
sudo ufw allow 443/tcp
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–æ–∫—Å–∏:

```nginx
location /api/kuliga/payment/callback {
    proxy_pass http://localhost:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 6. –¢–µ—Å—Ç–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ endpoint

–°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
curl -X POST https://gornostyle72.ru/api/kuliga/payment/callback \
  -H "Content-Type: application/json" \
  -d '{}' \
  -v
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `200 OK`.

---

## üöÄ –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å

–ò—Å–ø–æ–ª—å–∑—É–π –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
- https://www.uptrends.com/tools/uptime
- https://downforeveryoneorjustme.com/

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ - —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–ø—É—Å—Ç–æ–π payload) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 200 OK.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ telnet

```bash
telnet gornostyle72.ru 443
```

–î–æ–ª–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π

- [ ] URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (curl –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200)
- [ ] HTTPS —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–∞–ª–∏–¥–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)
- [ ] –ü–æ—Ä—Ç 443 –æ—Ç–∫—Ä—ã—Ç –≤ firewall
- [ ] Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
- [ ] –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –¥–æ—Ö–æ–¥—è—Ç –¥–æ endpoint

---

## üîÑ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä:
   ```bash
   pm2 restart gornostyle
   ```

2. –ü–æ–ø—Ä–æ–±—É–π –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫ —Å–Ω–æ–≤–∞:
   ```bash
   node scripts/register-tochka-webhook.js
   ```

3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
   ```bash
   pm2 logs gornostyle --lines 0
   ```

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–∞–Ω–∫–∞:**
- ‚úÖ HTTPS –Ω–∞ –ø–æ—Ä—Ç—É 443
- ‚úÖ Endpoint –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å HTTP 200 –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- ‚úÖ –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 30 —Å–µ–∫—É–Ω–¥

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–∞–Ω–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:**
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL
2. –û–∂–∏–¥–∞–µ—Ç HTTP 200 –≤ –æ—Ç–≤–µ—Ç–µ
3. –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç 200 - —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–µ–±—Ö—É–∫
4. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç 200 - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 400

