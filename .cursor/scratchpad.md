# Скрэтчпад проекта

## Background and Motivation
Пользователь хочет формализовать связь между «расписанием буднего дня на естественном склоне (ЗИМА)» и созданием тренировок. Нужна новая страница «Управление расписанием (ЗИМА)» во вкладке «Тренировки ЗИМА». На странице:
- кнопка «Создать расписание» (на дату или массово по диапазону и выбранным дням недели);
- предзаполнение стандартными временными слотами (как в текущей `winter_schedule`), с возможностью удалить/отредактировать/добавить слоты (время произвольное);
- после публикации расписания на дату админ может создавать групповые тренировки в эти слоты, а пользователи — записываться на индивидуальные (в свободные слоты).

## Key Challenges and Analysis
- Использовать существующую таблицу `winter_schedule` (новых таблиц не добавляем). Снять жёсткий `CHECK valid_time_slots` и валидировать только формат времени и отсутствие дублирования времени в пределах даты.
- Разрешить групповые и индивидуальные тренировки в любой день, если на дату есть расписание (хотя бы один слот в `winter_schedule`).
- Считаем дату «занятой расписанием», если в `winter_schedule` есть хотя бы один слот на эту дату (новое расписание на ту же дату не создаём, только правки/удаление).
- Массовое создание: при коллизии дат — пропускать такие даты и показывать отчёт со списком пропущенных, «перезаписывать» не нужно.
- «Компоновки слотов» (например, «Праздничные дни») — пресеты опциональны, при необходимости хранить в JSON-файле вне Git (добавить путь в .gitignore). Дефолтные пресеты не поставляем.
- Интеграция: создание групповой тренировки назначает тренера в `training_sessions` и помечает соответствующий слот как занятый; индивидуальная запись недоступна в занятый слот.
- Таймзона: аккуратная работа с датой/временем в API и на фронте.

## High-level Task Breakdown (с критериями успеха)
1) Правила данных и ограничения для `winter_schedule`
- Снять/изменить `CHECK valid_time_slots`; валидации на уровне API: формат времени, отсутствие дубля времени в пределах даты (уникальность на уровне `(date, time_slot)`).
- Критерии: можно создавать произвольные/стандартные слоты, нет дублей слотов и нет дублей расписаний на дату.

2) API для расписания (без новых таблиц)
- Эндпоинты админа:
  - POST `/api/winter-schedule/day` — создать слоты на дату из списка времен; если на дату уже есть расписание — 409 + список существующих.
  - POST `/api/winter-schedule/bulk` — массовое создание по диапазону и дням недели; коллизии пропускаем и возвращаем массив пропущенных дат.
  - GET `/api/winter-schedule/:date` — получить слоты на дату.
  - PUT `/api/winter-schedule/:date` — заменить/отредактировать набор слотов на дату (без дублей по времени).
  - DELETE `/api/winter-schedule/:date` — удалить все слоты на дату (с проверками: если есть занятые/привязанные слоты — политика запрета/подтверждения).
  - POST `/api/winter-schedule/:date/slots` — добавить слот(ы); DELETE `/api/winter-schedule/:date/slots/:time` — удалить слот.
- Критерии: корректная работа с конфликтами, понятные коды/сообщения.

3) Изменения в логике тренингов
- Разрешить создавать групповые тренировки в любой день при наличии расписания на дату; валидация: начало тренировки должно совпадать с существующим слотом даты.
- При создании групповой тренировки «занимать» слот (чтобы индивидуалка не встала в это время). При удалении — освобождать.
- Критерии: тренировки создаются в будние дни при наличии слотов; исключена двойная бронь слота.

4) Админ UI: страница «Управление расписанием (ЗИМА)»
- Раздел «На дату»: выбор даты, ввод списка времен, таблица редактирования (add/remove/edit), сохранить.
- Раздел «Массово»: диапазон дат, выбор дней недели, ввод/выбор списка времен; отчёт о пропущенных датах.
- Критерии: UX позволяет быстро создать/править расписание на день/диапазон.

5) Пресеты компоновок (опционально, вне Git)
- При необходимости использовать файл, например `config/winter-slot-presets.json` (в `.gitignore`); структура: { key, name, times[] }.
- Критерии: если нужны пресеты — админ может их хранить на сервере без конфликтов Git.

6) Интеграция и транзакционная целостность
- Операции с занятием/освобождением слота — атомарно совместно с созданием/удалением тренировки.
- Критерии: отсутствуют race conditions и двойные брони.

7) Тесты и логи
- Сценарии: одиночное/массовое создание, коллизии, создание групповой в будний день, блокировка индивидуалки в занятый слот.
- Критерии: тесты проходят; логи помогают диагностике.

## Project Status Board
- [x] Уточнить требования по слотам, тренерам, длительности, ценам
- [ ] Спроецировать изменения ограничений/валидаций для `winter_schedule`
- [ ] Реализовать API расписания на конкретный день и массового создания
- [ ] Разрешить групповые/индивидуальные тренировки в любой день при наличии расписания
- [ ] Реализовать страницу «Управление расписанием (ЗИМА)»
- [ ] Добавить кнопку «Управление расписанием» в «Тренировки ЗИМА»
- [ ] (Опционально) Поддержать пресеты компоновок через JSON вне Git
- [ ] Добавить валидации и обработку коллизий
- [ ] Добавить тесты и логи
- [ ] Обновить документацию

## Current Status / Progress Tracking
Режим Планировщика: решения подтверждены. Готов к детализации контрактов API и UI, затем к реализации.

## Executor's Feedback or Assistance Requests
Открытых вопросов нет. Дефолтные пресеты не требуются; UI позволит вводить времена вручную и сохранять на дату/диапазон.

## Lessons
- Снятие жёстких CHECK-ограничений в пользу серверных валидаций повышает гибкость, но требует аккуратных проверок уникальности и коллизий в API.
