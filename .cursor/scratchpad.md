# 🧹 План: Логи и очистка диска (Planner)

## Background and Motivation
- После последнего деплоя логи, вероятно, перестали ротироваться/очищаться → переполнение диска и OOM на сервере.
- Нужно зафиксировать текущие источники логов, способы ротации/очистки, и предложить устойчивую схему удержания логов.

## Key Challenges and Analysis
- Источники логов: PM2 пишет `./logs/combined.log`, `./logs/out.log`, `./logs/error.log` (см. `ecosystem.config.js`). Есть отдельные файлы `server.log`, `schedule-cron.log`. Возможны дополнительные логи из пользовательских скриптов.
- Не обнаружено конфигурации logrotate/pm2-logrotate или самостоятельной ротации в коде/cron.
- Нет явных скриптов очистки логов; в `.gitignore` папка `logs/` исключена, поэтому на сервере могут копиться большие файлы.
- Нужно проверить, не пишет ли `src/app.js` и cron-скрипты в отдельные файлы, а также какие задачи запускает `scheduler.js`.

## High-level Task Breakdown
- Задача 1: Инвентаризация источников логов
  - Успех: список всех файлов/директорий логов (PM2, кастомные файлы, cron-скрипты), пути, размер/рост (при наличии данных), кто их пишет.
- Задача 2: Проверка текущей ротации/очистки
  - Успех: подтверждено наличие/отсутствие logrotate/pm2-logrotate/ручных скриптов и расписаний; понятно, какой ретеншн действует сейчас.
- Задача 3: Опции исправления
  - Успех: сформирован набор предложений (в т.ч. безостановочные: pm2-logrotate с лимитами размера/хранения; системный logrotate; перевод на stdout-only + внешняя ротация; очистка исторических файлов/backup логов).
- Задача 4: План внедрения (последовательность, риски, тесты)
  - Успех: шаги согласованы, включая точки контроля и команды для прод-сервера.

## Project Status Board
- [x] Задача 1: Инвентаризация логов
- [x] Задача 2: Проверка ротации/очистки
- [x] Задача 3: Предложить варианты решения
- [ ] Задача 4: Согласовать и подготовить внедрение

## Current Status / Progress Tracking
- Режим: 🛠 Executor
- Факты на проде `/root/project/gornostyle`:
  - PM2 процесс `gornostyle` (fork, node 18.20.8); логи в `logs/combined-0.log`, `logs/error-0.log`, `logs/out-0.log`.
  - До вмешательства логи ~60–75 MB каждый, ротации не было; `schedule-cron.log` 552 B; других ротаций/cron нет.
  - В `/etc/logrotate.d` отсутствовали правила для проекта/pm2.
- Сделано:
  - Установлен `pm2-logrotate` через `pm2 install pm2-logrotate`; конфиг: `max_size 10M`, `retain 7`, `compress true`, `workerInterval 1800s`, `rotateInterval 0 0 * * *`.
  - Создан системный logrotate `/etc/logrotate.d/gornostyle` для `/root/project/gornostyle/logs/*.log`: `daily`, `size 10M`, `rotate 7`, `compress`, `delaycompress`, `copytruncate`, `create 640 root root`.
  - Выполнена принудительная ротация `logrotate -f`: текущие файлы ~31K/0, архивы `.1` ~1.6MB, `.2.gz` ~0.9MB; суммарно ~4.9MB.
  - Добавлена ежедневная чистка бэкапов `/etc/cron.daily/gornostyle-backup-clean`: удаляет файлы `skisimulator_*.sql.gz`, `*.dump`, `*.backup` старше 35 дней в `/root/gornostyle-backups` и `/root/project/gornostyle`, лог в `/var/log/gornostyle-backup-clean.log`.
- Следующие шаги: подтвердить, что устраивает хранение 7 дней/10MB; при необходимости скорректировать (например, `retain 14` или `size 50M`).

## Executor's Feedback or Assistance Requests
- Уточнить целевой ретеншн: сколько дней и максимальный объем логов (сейчас 7 ротаций по 10MB, compress).
- Ротация/очистка бэкапов сейчас 35 дней; подтвердить срок (можно 30/60). При необходимости добавить другие директории/паттерны.

## Lessons
- Будут дополняться после исследования.

# 🎟️ ПЛАН: УЛУЧШЕНИЕ ВКЛАДКИ СЕРТИФИКАТОВ В АДМИН-ПАНЕЛИ

## Background and Motivation

### Текущее состояние системы сертификатов

**Система сертификатов** позволяет клиентам покупать и активировать подарочные сертификаты на услуги школы.

#### Как работают сертификаты сейчас:

**1. Создание (покупка):**
- **Через бота:** Клиент выбирает номинал (500-50000₽), дизайн, заполняет данные получателя, оплачивает через СБП → создается сертификат
- **Через сайт:** Форма покупки сертификата → регистрация клиента → оплата → создание сертификата
- **Процесс:**
  - Генерируется уникальный 6-значный номер
  - Создается запись в БД (`certificates`) со статусом `active`
  - Устанавливается срок действия: `expiry_date = purchase_date + 1 год`
  - Списываются средства с кошелька покупателя (или через Tinkoff Acquiring)
  - Генерируется JPG файл сертификата
  - Отправляется уведомление покупателю и администратору
- **API:** `POST /api/certificates/purchase`
- **Файлы:** `src/routes/certificates.js` (строки 53-327), `src/routes/sms.js` (строки 7-217)

**2. Активация:**
- **Через бота:** Клиент вводит 6-значный номер → система проверяет и активирует
- **Процесс:**
  - Проверка существования и статуса сертификата
  - Проверка срока действия (`expiry_date >= now`)
  - Зачисление средств на кошелек клиента
  - Смена статуса: `active` → `used`
  - Установка `activation_date` и `activated_by_id`
  - Создание транзакции
  - Отправка уведомлений
- **API:** `POST /api/certificates/activate`
- **Файлы:** `src/routes/certificates.js` (строки 330-541), `src/bot/client-bot.js` (строки 12077-12164)

**3. Трата:**
- После активации средства поступают на кошелек клиента
- Тратятся как обычные средства при записи на тренировки
- Отслеживается через транзакции (`transactions`)

**4. Сгорание (истечение срока):**
- ❌ **ПРОБЛЕМА:** Нет автоматической задачи в `scheduler.js` для пометки просроченных сертификатов!
- Проверка срока действия происходит **только при активации** (вручную)
- Статус `expired` существует в БД, но не устанавливается автоматически
- **Рекомендация:** Добавить cron-задачу для автоматической пометки просроченных сертификатов

#### База данных:

**Таблицы:**
```sql
-- Сертификаты
CREATE TABLE certificates (
    id SERIAL PRIMARY KEY,
    certificate_number VARCHAR(12) UNIQUE NOT NULL,      -- 6-значный номер
    purchaser_id INTEGER REFERENCES clients(id),         -- кто купил
    recipient_name VARCHAR(100),                         -- кому подарили
    recipient_phone VARCHAR(20),                         -- телефон получателя
    nominal_value DECIMAL(10,2) NOT NULL,                -- номинал (500-50000)
    design_id INTEGER REFERENCES certificate_designs(id), -- дизайн
    status VARCHAR(20) DEFAULT 'active',                 -- active, used, expired, cancelled
    expiry_date TIMESTAMP NOT NULL,                      -- срок действия (1 год)
    activated_by_id INTEGER REFERENCES clients(id),      -- кто активировал
    activation_date TIMESTAMP,                           -- дата активации
    message TEXT,                                        -- пожелание
    purchase_date TIMESTAMP NOT NULL,                    -- дата покупки
    pdf_url VARCHAR(255),                                -- URL JPG файла
    image_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Дизайны сертификатов
CREATE TABLE certificate_designs (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,        -- Название дизайна
    description TEXT,
    image_url VARCHAR(255) NOT NULL,   -- Превью
    template_url VARCHAR(255) NOT NULL,-- Шаблон HTML
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### API Endpoints (существующие):

| Endpoint | Метод | Описание | Статус |
|----------|-------|----------|--------|
| `/api/certificates/purchase` | POST | Создание сертификата | ✅ Работает |
| `/api/certificates/activate` | POST | Активация сертификата | ✅ Работает |
| `/api/certificates/designs` | GET | Получение дизайнов | ✅ Работает |
| `/api/certificates/:number` | GET | Просмотр сертификата по номеру | ✅ Работает |
| `/api/certificates/user/:client_id` | GET | Сертификаты пользователя | ✅ Работает |
| `/api/certificates/admin/statistics` | GET | Статистика для админа | ✅ Работает |
| `/api/certificates/register` | POST | Регистрация для покупки | ✅ Работает |
| `/api/certificates/preview` | POST | Предпросмотр сертификата | ✅ Работает |

#### Текущая админ-панель (`public/admin.html`, `public/js/admin.js`):

**Проблемы:**
- ❌ Очень простая реализация (строки 3203-3230 в admin.js)
- ❌ Обращается к несуществующему API `/api/certificates` (нет такого endpoint!)
- ❌ Минимальный функционал (просто список)
- ❌ Нет фильтров по статусу, дате, номиналу
- ❌ Нет поиска по номеру/покупателю
- ❌ Нет управления сертификатами (отмена, продление)
- ❌ Нет детальной информации
- ❌ Нет статистики и аналитики

---

## Key Challenges and Analysis

### Проблемы текущей реализации:

1. **Отсутствует детальный API для админа:**
   - Нет endpoint для получения списка всех сертификатов с фильтрами
   - Нужен: `GET /api/certificates/admin/list?status=active&search=123456&start_date=2025-01-01&end_date=2025-12-31&sort=purchase_date&order=DESC&limit=50&offset=0`

2. **Нет автоматического сгорания сертификатов:**
   - Сертификаты с `expiry_date < NOW()` остаются в статусе `active`
   - Нужна cron-задача в `scheduler.js` (каждый день в 00:00)

3. **Нет управления сертификатами:**
   - Нельзя отменить сертификат (`status = 'cancelled'`)
   - Нельзя продлить срок действия
   - Нельзя изменить данные (имя получателя, сообщение)

4. **Нет мониторинга:**
   - Нет списка скоро истекающих сертификатов (expires_in < 7 days)
   - Нет оповещений о неактивированных сертификатах
   - Нет отчетов по конверсии (active → used)

5. **Нет детальной информации о сертификате:**
   - История операций (создание, активация)
   - Транзакции (списание средств покупателя, зачисление активатору)
   - Связь с клиентами (покупатель, активатор)

### Что нужно администратору:

**Мониторинг:**
- Список всех сертификатов с фильтрами и поиском
- Статистика (общая сумма, конверсия, популярные номиналы)
- Сертификаты, истекающие скоро (≤ 7 дней)
- Неактивированные сертификаты старше 30 дней

**Управление:**
- Просмотр детальной информации о сертификате
- Отмена сертификата (refund)
- Продление срока действия
- Редактирование данных (имя, сообщение)
- Ручное создание сертификата (для особых случаев)
- Повторная отправка сертификата клиенту

**Аналитика:**
- Динамика продаж (по дням/неделям/месяцам)
- Конверсия активации (%)
- Средний чек
- Популярные номиналы и дизайны
- Время от покупки до активации
- География покупателей (если есть данные)

---

## High-level Task Breakdown

### ЭТАП 1: Backend - API для админа ✅ **ЗАВЕРШЕНО** (05.12.2025)

#### Задача 1.1: Создать API для получения списка сертификатов с фильтрами ✅
- **Endpoint:** `GET /api/certificates/admin/list`
- **Query параметры:**
  - `status` (active|used|expired|cancelled) - фильтр по статусу
  - `search` - поиск по номеру сертификата, имени покупателя/получателя, телефону
  - `start_date` - фильтр по дате покупки (от)
  - `end_date` - фильтр по дате покупки (до)
  - `min_value` - минимальный номинал
  - `max_value` - максимальный номинал
  - `design_id` - фильтр по дизайну
  - `expiring_soon` (boolean) - только сертификаты, истекающие в течение 7 дней
  - `sort` (purchase_date|expiry_date|nominal_value|activation_date) - поле сортировки
  - `order` (ASC|DESC) - порядок сортировки
  - `limit` - количество записей на странице (по умолчанию 50)
  - `offset` - смещение для пагинации
- **Ответ:**
  ```json
  {
    "success": true,
    "certificates": [
      {
        "id": 123,
        "certificate_number": "123456",
        "purchaser": {
          "id": 45,
          "full_name": "Иванов Иван Иванович",
          "phone": "+79123456789"
        },
        "recipient_name": "Петров Петр",
        "nominal_value": 5000,
        "design": {
          "id": 1,
          "name": "Классический"
        },
        "status": "active",
        "purchase_date": "2025-11-01T10:00:00Z",
        "expiry_date": "2026-11-01T10:00:00Z",
        "days_until_expiry": 331,
        "activated_by": null,
        "activation_date": null,
        "pdf_url": "/generated/certificates/certificate_123456.jpg",
        "message": "С Новым Годом!"
      }
    ],
    "total": 150,
    "page": 1,
    "limit": 50,
    "total_pages": 3
  }
  ```
- **Критерий успеха:** API возвращает список сертификатов с полной информацией и пагинацией

#### Задача 1.2: Создать API для детальной информации о сертификате
- **Endpoint:** `GET /api/certificates/admin/:id`
- **Ответ:**
  ```json
  {
    "success": true,
    "certificate": {
      "id": 123,
      "certificate_number": "123456",
      "purchaser": {
        "id": 45,
        "full_name": "Иванов Иван Иванович",
        "phone": "+79123456789",
        "email": "ivan@example.com",
        "telegram_id": "123456789"
      },
      "recipient_name": "Петров Петр",
      "recipient_phone": "+79987654321",
      "nominal_value": 5000,
      "design": {
        "id": 1,
        "name": "Классический",
        "image_url": "/images/certificates/classic.jpg"
      },
      "status": "active",
      "purchase_date": "2025-11-01T10:00:00Z",
      "expiry_date": "2026-11-01T10:00:00Z",
      "days_until_expiry": 331,
      "activated_by": null,
      "activation_date": null,
      "pdf_url": "/generated/certificates/certificate_123456.jpg",
      "message": "С Новым Годом!",
      "transactions": [
        {
          "id": 456,
          "amount": -5000,
          "type": "payment",
          "description": "Покупка сертификата",
          "created_at": "2025-11-01T10:00:00Z"
        }
      ],
      "created_at": "2025-11-01T10:00:00Z",
      "updated_at": "2025-11-01T10:00:00Z"
    }
  }
  ```
- **Критерий успеха:** API возвращает полную информацию о сертификате с историей транзакций

#### Задача 1.3: Создать API для управления сертификатами
- **Endpoint:** ~~`PUT /api/certificates/admin/:id/cancel`~~ ❌ ОТМЕНЕНО - отмена сертификата невозможна
- **Endpoint:** `PUT /api/certificates/admin/:id/extend` - продление срока действия
  - **Body:** `{ new_expiry_date: "2027-01-01" }` или `{ extend_days: 90 }`
  - **Логика:**
    - Обновляет `expiry_date`
    - Если статус `expired` → меняет на `active`
    - Отправляет уведомление получателю
- **Endpoint:** `PUT /api/certificates/admin/:id/edit` - редактирование данных
  - **Body:** `{ recipient_name: "Новое имя", message: "Новое сообщение" }`
  - **Логика:**
    - Обновляет данные
    - Регенерирует JPG файл (если изменилось имя/сообщение)
- **Endpoint:** `POST /api/certificates/admin/:id/resend` - повторная отправка
  - **Логика:**
    - Отправляет сертификат на email/телеграм покупателя
    - Логирует событие
- **Критерий успеха:** Все операции управления работают корректно с уведомлениями

#### Задача 1.4: Создать API для ручного создания сертификата
- **Endpoint:** `POST /api/certificates/admin/create`
- **Body:**
  ```json
  {
    "purchaser_id": 45,
    "recipient_name": "Иванов Иван",
    "recipient_phone": "+79123456789",
    "nominal_value": 5000,
    "design_id": 1,
    "message": "С праздником!",
    "expiry_date": "2026-12-31",
    "skip_payment": true,  // Не списывать средства с кошелька
    "reason": "Промо-акция для постоянного клиента"
  }
  ```
- **Логика:**
  - Создает сертификат без списания средств (если `skip_payment = true`)
  - Генерирует JPG
  - Отправляет уведомление
  - Логирует создание администратором
- **Критерий успеха:** Администратор может создавать сертификаты вручную

#### Задача 1.5: Расширить API статистики
- **Endpoint:** `GET /api/certificates/admin/statistics`
- **Query параметры:** `start_date`, `end_date`
- **Добавить в ответ:**
  - `expiring_soon_count` - количество сертификатов, истекающих в течение 7 дней
  - `not_activated_30_days_count` - неактивированные сертификаты старше 30 дней
  - `cancelled_certificates` - количество отмененных
  - `average_time_to_activation_days` - среднее время от покупки до активации (дни)
  - `conversion_rate` - процент активации (used / (active + used + expired))
  - `sales_by_day` - массив продаж по дням
  - `sales_by_design` - продажи по дизайнам
- **Критерий успеха:** Статистика предоставляет полную аналитику

---

### ЭТАП 2: Backend - Автоматическое сгорание сертификатов 🔄 В РАБОТЕ

#### Задача 2.1: Создать cron-задачу для пометки просроченных сертификатов ✅
- **Файл:** `src/services/scheduler.js`
- **Задача:** `scheduleCertificateExpiration()` - запуск каждый день в 00:00
- **Логика:**
  ```javascript
  // Находим все сертификаты со статусом 'active', у которых expiry_date < NOW()
  UPDATE certificates 
  SET status = 'expired', updated_at = CURRENT_TIMESTAMP 
  WHERE status = 'active' AND expiry_date < NOW()
  RETURNING id, certificate_number, purchaser_id, recipient_name;
  
  // Отправляем уведомления:
  // - Покупателю (если не активировал)
  // - Администратору (сводка за день)
  ```
- **Уведомления:**
  - Покупателю: "Срок действия сертификата истек"
  - Администратору: "Сегодня истекло 5 сертификатов на сумму 25000₽"
- **Критерий успеха:** Просроченные сертификаты автоматически помечаются статусом `expired`

#### Задача 2.2: ~~Создать задачу для напоминания об истекающих сертификатах~~ ❌ ОТМЕНЕНО
- **Причина отмены:** Покупатель может расстроиться, если получатель не воспользовался подарком
- Напоминания об истечении НЕ отправляются

---

### ЭТАП 3: Frontend - Интерфейс админ-панели ⏳

#### Задача 3.1: Создать дизайн вкладки "Сертификаты"
- **Макет:** Современный интерфейс с фильтрами и таблицей
- **Секции:**
  1. **Шапка:**
     - Заголовок "Сертификаты"
     - Кнопка "Создать сертификат" (ручное создание)
     - Кнопка "Статистика"
  2. **Фильтры:**
     - Строка поиска (по номеру, имени, телефону)
     - Селект "Статус" (Все / Active / Used / Expired / Cancelled)
     - Диапазон дат (от - до)
     - Диапазон номиналов (от - до)
     - Селект "Дизайн"
     - Чекбокс "Истекают скоро (≤ 7 дней)"
  3. **Таблица сертификатов:**
     - Колонки: Номер | Покупатель | Получатель | Номинал | Дизайн | Статус | Дата покупки | Срок действия | Действия
     - Пагинация (50 записей на странице)
     - Сортировка по всем колонкам
  4. **Карточки быстрого доступа (над таблицей):**
     - "Всего сертификатов: 150" (кликабельно → фильтр "Все")
     - "Активных: 80" (→ фильтр "Active")
     - "Использованных: 60" (→ фильтр "Used")
     - "Истекло: 10" (→ фильтр "Expired")
     - "Истекает скоро: 5" (→ фильтр "Истекают скоро")
- **Индикаторы статуса (цветные бейджи):**
  - 🟢 `active` - зеленый
  - 🔵 `used` - синий
  - 🔴 `expired` - красный
  - ⚫ `cancelled` - серый
- **Индикатор срока действия:**
  - ⚠️ Если истекает через ≤ 7 дней → оранжевая подсветка
- **Критерий успеха:** Удобный интерфейс с понятной навигацией

#### Задача 3.2: Реализовать функционал фильтрации и поиска
- **Файл:** `public/js/admin.js` (новая функция `loadCertificatesAdmin()`)
- **Логика:**
  - При изменении фильтров → запрос к API с query параметрами
  - Дебаунс для поиска (300ms)
  - Сохранение состояния фильтров в localStorage
  - Обновление счетчиков карточек
- **Критерий успеха:** Фильтры и поиск работают моментально

#### Задача 3.3: Реализовать модальное окно детальной информации
- **Триггер:** Клик на строку таблицы или кнопка "Просмотр"
- **Содержимое модального окна:**
  - Превью JPG сертификата
  - Вся информация о сертификате
  - История транзакций
  - Данные покупателя и активатора (с ссылками на профили)
  - **Кнопки действий:**
    - "Скачать JPG"
    - "Отправить повторно"
    - "Редактировать" (имя, сообщение)
    - "Продлить срок"
    - "Отменить сертификат" (если `active`)
- **Критерий успеха:** Вся информация отображается корректно, действия работают

#### Задача 3.4: Реализовать формы управления
- **Форма "Отмена сертификата":**
  - Поле "Причина отмены" (обязательное)
  - Чекбокс "Вернуть средства на кошелек покупателя"
  - Кнопки "Отменить сертификат" / "Закрыть"
- **Форма "Продление срока":**
  - Выбор новой даты (datepicker) или количество дней
  - Кнопки "Продлить" / "Закрыть"
- **Форма "Редактирование":**
  - Поле "Имя получателя"
  - Поле "Сообщение"
  - Примечание: "JPG будет перегенерирован"
  - Кнопки "Сохранить" / "Закрыть"
- **Критерий успеха:** Формы валидируются, отправляют запросы, показывают результат

#### Задача 3.5: Реализовать форму ручного создания сертификата
- **Триггер:** Кнопка "Создать сертификат" в шапке
- **Поля:**
  - Поиск покупателя (автокомплит по имени/телефону)
  - Имя получателя (опционально)
  - Телефон получателя (опционально)
  - Номинал (500-50000)
  - Дизайн (селект с превью)
  - Сообщение (опционально)
  - Дата истечения (по умолчанию +1 год)
  - Чекбокс "Не списывать средства с кошелька" (для промо/подарков)
  - Причина создания (текстовое поле)
- **Критерий успеха:** Администратор может создать сертификат вручную

#### Задача 3.6: Реализовать страницу статистики
- **Секции:**
  1. **Фильтр периода:** (последний месяц / последние 3 месяца / год / произвольный период)
  2. **Карточки с метриками:**
     - Всего сертификатов
     - Общая сумма продаж
     - Средний чек
     - Конверсия активации (%)
     - Неактивированных сертификатов
     - Среднее время до активации (дни)
  3. **Графики:**
     - График продаж по дням (Line chart)
     - Распределение по статусам (Pie chart)
     - Популярные номиналы (Bar chart)
     - Популярные дизайны (Bar chart)
  4. **Таблица популярных номиналов:**
     - Номинал | Количество | Процент
  5. **Таблица популярных дизайнов:**
     - Дизайн | Количество | Процент
- **Библиотека графиков:** Chart.js
- **Критерий успеха:** Статистика визуализирована и понятна

---

### ЭТАП 4: Тестирование ⏳

#### Задача 4.1: Функциональное тестирование API
- Создание сертификата вручную
- Фильтрация списка сертификатов
- Поиск по номеру/имени
- Детальная информация
- Отмена сертификата с возвратом средств
- Продление срока
- Редактирование данных с перегенерацией JPG
- Повторная отправка сертификата

#### Задача 4.2: Тестирование автоматических задач
- Запуск задачи пометки просроченных (вручную)
- Проверка уведомлений
- Запуск задачи напоминаний (вручную)

#### Задача 4.3: Тестирование UI
- Проверка всех фильтров
- Проверка пагинации
- Проверка модальных окон
- Проверка форм управления
- Проверка статистики

---

## Proposed Solution - Подробный функционал

### Интерфейс администратора - Мониторинг

#### 1. Главный экран "Сертификаты"

**Верхняя панель (Dashboard Cards):**
```
┌─────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┐
│ 📊 ВСЕГО            │ 🟢 АКТИВНЫХ         │ 🔵 ИСПОЛЬЗОВАННЫХ   │ 🔴 ИСТЕКЛО          │
│ 150 сертификатов    │ 80 сертификатов     │ 60 сертификатов     │ 10 сертификатов     │
│ 750 000 ₽           │ 400 000 ₽           │ 300 000 ₽           │ 50 000 ₽            │
└─────────────────────┴─────────────────────┴─────────────────────┴─────────────────────┘

┌─────────────────────┬─────────────────────┐
│ ⚠️ ИСТЕКАЕТ СКОРО   │ 📈 КОНВЕРСИЯ        │
│ 5 сертификатов      │ 85.7%               │
│ (≤ 7 дней)          │ (60 / 70 активир.)  │
└─────────────────────┴─────────────────────┘
```

**Панель фильтров и поиска:**
```
┌────────────────────────────────────────────────────────────────────────────┐
│ 🔍 Поиск                                                                   │
│ ┌──────────────────────────────────────────────────────────────────────┐   │
│ │ Поиск по номеру, имени покупателя/получателя, телефону...          │   │
│ └──────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│ Статус: [Все ▼]  Дизайн: [Все ▼]  Период: [От: __/__/__] [До: __/__/__] │
│                                                                            │
│ Номинал: От [____] До [____]  ☑ Только истекающие скоро               │
│                                                                            │
│ [Применить фильтры]  [Сбросить]                   [+ Создать сертификат]  │
└────────────────────────────────────────────────────────────────────────────┘
```

**Таблица сертификатов:**
```
┌──────────┬──────────────────┬──────────────────┬──────────┬────────────┬────────┬──────────────┬──────────────┬────────────┐
│ Номер    │ Покупатель       │ Получатель       │ Номинал  │ Дизайн     │ Статус │ Дата покупки │ Истекает     │ Действия   │
├──────────┼──────────────────┼──────────────────┼──────────┼────────────┼────────┼──────────────┼──────────────┼────────────┤
│ 123456   │ Иванов Иван      │ Петров Петр      │ 5 000 ₽  │ Класс.     │ 🟢     │ 01.11.2025   │ ⚠️ 5 дней   │ [👁][✏][❌]│
│          │ +79123456789     │ +79987654321     │          │            │ Active │              │              │            │
├──────────┼──────────────────┼──────────────────┼──────────┼────────────┼────────┼──────────────┼──────────────┼────────────┤
│ 654321   │ Сидоров Петр     │ Себе             │ 10 000 ₽ │ Спорт.     │ 🔵     │ 15.10.2025   │ Активирован  │ [👁][✏]    │
│          │ +79111111111     │                  │          │            │ Used   │              │ 20.10.2025   │            │
├──────────┼──────────────────┼──────────────────┼──────────┼────────────┼────────┼──────────────┼──────────────┼────────────┤
│ 789012   │ Кузнецов А.      │ Маме             │ 3 000 ₽  │ Праздн.    │ 🔴     │ 01.01.2025   │ Истек        │ [👁][🔄]   │
│          │ +79222222222     │ Кузнецова М.     │          │            │ Expired│              │ 01.01.2026   │            │
└──────────┴──────────────────┴──────────────────┴──────────┴────────────┴────────┴──────────────┴──────────────┴────────────┘

Показано 1-50 из 150        [< Назад] [Страница 1 из 3] [Вперед >]
```

**Легенда действий:**
- 👁 - Просмотр детальной информации
- ✏ - Редактировать
- ❌ - Отменить сертификат (только для `active`)
- 🔄 - Продлить срок (для `expired`)

---

#### 2. Модальное окно "Детальная информация о сертификате"

```
┌─────────────────────────────────────────────────────────────────────┐
│ Сертификат #123456                                          [✕]     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ ┌─────────────────────────────────────────────────────────────┐   │
│ │                                                               │   │
│ │            [Превью JPG сертификата]                          │   │
│ │            (кликабельно для увеличения)                      │   │
│ │                                                               │   │
│ └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ 📋 ОСНОВНАЯ ИНФОРМАЦИЯ                                             │
│ ┌─────────────────────────────────────────────────────────────┐   │
│ │ Номинал:        5 000 ₽                                      │   │
│ │ Статус:         🟢 Active                                    │   │
│ │ Дизайн:         Классический                                 │   │
│ │ Сообщение:      "С Новым Годом! Желаю успехов!"             │   │
│ │                                                               │   │
│ │ Дата покупки:   01.11.2025 10:30                             │   │
│ │ Истекает:       01.11.2026 10:30 (через 331 день)           │   │
│ └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ 👤 ПОКУПАТЕЛЬ                                                      │
│ ┌─────────────────────────────────────────────────────────────┐   │
│ │ ФИО:            Иванов Иван Иванович [👁 Профиль]           │   │
│ │ Телефон:        +79123456789                                 │   │
│ │ Email:          ivan@example.com                             │   │
│ │ Telegram:       @ivanov                                      │   │
│ └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ 🎁 ПОЛУЧАТЕЛЬ                                                      │
│ ┌─────────────────────────────────────────────────────────────┐   │
│ │ Имя:            Петров Петр                                  │   │
│ │ Телефон:        +79987654321                                 │   │
│ └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ 💳 ТРАНЗАКЦИИ                                                      │
│ ┌─────────────────────────────────────────────────────────────┐   │
│ │ 01.11.2025 10:30  Списание с кошелька    -5 000 ₽          │   │
│ │                   (Покупка сертификата)                      │   │
│ └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│ ───────────────────────────────────────────────────────────────   │
│                                                                     │
│ [📥 Скачать JPG] [📧 Отправить повторно] [✏️ Редактировать]      │
│ [⏰ Продлить срок] [❌ Отменить сертификат]                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

#### 3. Форма "Отмена сертификата"

```
┌─────────────────────────────────────────────────────────────┐
│ Отмена сертификата #123456                          [✕]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ⚠️ ВНИМАНИЕ: Эта операция необратима!                     │
│                                                             │
│ Номинал:    5 000 ₽                                        │
│ Покупатель: Иванов Иван Иванович                           │
│                                                             │
│ Причина отмены: *                                          │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Возврат средств по запросу клиента                   │   │
│ │                                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ☑ Вернуть средства на кошелек покупателя               │
│                                                             │
│ После отмены:                                              │
│ • Статус сертификата изменится на "Cancelled"             │
│ • Средства вернутся на кошелек (если выбрана опция)       │
│ • Покупатель получит уведомление                          │
│                                                             │
│          [Отменить сертификат]  [Закрыть]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

#### 4. Форма "Продление срока действия"

```
┌─────────────────────────────────────────────────────────────┐
│ Продление срока действия #123456                    [✕]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Номинал:         5 000 ₽                                   │
│ Текущий срок:    01.11.2026 10:30 (истек)                 │
│                                                             │
│ Способ продления:                                          │
│ ⦿ На количество дней                                      │
│ ○ До конкретной даты                                       │
│                                                             │
│ Продлить на:                                               │
│ ┌───────┐ дней                                            │
│ │  90   │                                                  │
│ └───────┘                                                  │
│                                                             │
│ Новый срок: 30.01.2027 10:30                              │
│                                                             │
│ После продления:                                           │
│ • Срок действия обновится                                 │
│ • Статус изменится на "Active" (если был "Expired")       │
│ • Получатель получит уведомление                          │
│                                                             │
│          [Продлить]  [Закрыть]                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

#### 5. Форма "Редактирование сертификата"

```
┌─────────────────────────────────────────────────────────────┐
│ Редактирование сертификата #123456                  [✕]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Имя получателя:                                            │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Петров Петр Петрович                                 │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ Сообщение:                                                 │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ С Новым Годом! Желаю здоровья и успехов!            │   │
│ │                                                       │   │
│ │                                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ℹ️ При сохранении JPG файл будет перегенерирован          │
│                                                             │
│          [Сохранить]  [Закрыть]                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

#### 6. Форма "Ручное создание сертификата"

```
┌─────────────────────────────────────────────────────────────┐
│ Создание сертификата вручную                        [✕]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 👤 ПОКУПАТЕЛЬ                                              │
│                                                             │
│ Поиск клиента: *                                           │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Начните вводить ФИО или телефон...                  │   │
│ └─────────────────────────────────────────────────────┘   │
│ ↓ Автокомплит:                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Иванов Иван Иванович | +79123456789                │   │
│ │ Иванова Мария Петровна | +79123456788              │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 🎁 ПОЛУЧАТЕЛЬ (опционально)                                │
│                                                             │
│ Имя получателя:                                            │
│ ┌─────────────────────────────────────────────────────┐   │
│ │                                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ Телефон получателя:                                        │
│ ┌─────────────────────────────────────────────────────┐   │
│ │                                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 💳 ПАРАМЕТРЫ СЕРТИФИКАТА                                   │
│                                                             │
│ Номинал (₽): *                                             │
│ ┌───────────┐                                              │
│ │  5000     │  (от 500 до 50 000)                         │
│ └───────────┘                                              │
│                                                             │
│ Дизайн: *                                                  │
│ ┌───────────────────────────────────────────────────┐     │
│ │ [🎨 Классический ▼]                                │     │
│ │                                                     │     │
│ │ Превью: [изображение дизайна]                      │     │
│ └───────────────────────────────────────────────────┘     │
│                                                             │
│ Сообщение (опционально):                                   │
│ ┌─────────────────────────────────────────────────────┐   │
│ │                                                       │   │
│ │                                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ Дата истечения: *                                          │
│ ┌───────────┐  (по умолчанию: +1 год)                    │
│ │ 05.12.2026│                                              │
│ └───────────┘                                              │
│                                                             │
│ ☑ Не списывать средства с кошелька                     │
│   (для промо-акций и подарков от школы)                   │
│                                                             │
│ Причина создания: *                                        │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Промо-акция для постоянного клиента                  │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│          [Создать сертификат]  [Закрыть]                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

#### 7. Страница "Статистика сертификатов"

```
┌─────────────────────────────────────────────────────────────────────┐
│ Статистика сертификатов                                     [✕]     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│ Период: [Последний месяц ▼]  [От: __/__/__] [До: __/__/__]       │
│                                                                     │
│ ┌─────────────────────┬─────────────────────┬─────────────────────┐│
│ │ 📊 ВСЕГО            │ 💰 СУММА ПРОДАЖ     │ 💵 СРЕДНИЙ ЧЕК      ││
│ │ 150 сертификатов    │ 750 000 ₽           │ 5 000 ₽             ││
│ └─────────────────────┴─────────────────────┴─────────────────────┘│
│                                                                     │
│ ┌─────────────────────┬─────────────────────┬─────────────────────┐│
│ │ 📈 КОНВЕРСИЯ        │ ⏱️ ДО АКТИВАЦИИ     │ ❌ НЕАКТИВИРОВАННЫХ ││
│ │ 85.7%               │ 12 дней             │ 20 сертификатов     ││
│ │ (60 / 70 активир.)  │ (средний срок)      │ (активных > 30 дн.) ││
│ └─────────────────────┴─────────────────────┴─────────────────────┘│
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐ │
│ │ 📈 ДИНАМИКА ПРОДАЖ                                            │ │
│ │                                                               │ │
│ │   [Line chart: продажи по дням]                              │ │
│ │   X: даты, Y: количество сертификатов / сумма (₽)           │ │
│ │                                                               │ │
│ └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│ ┌─────────────────────────────┬─────────────────────────────────┐ │
│ │ 🎨 ПО СТАТУСАМ              │ 💎 ПО ДИЗАЙНАМ                  │ │
│ │                             │                                 │ │
│ │ [Pie chart]                 │ [Bar chart]                     │ │
│ │ • Active: 80 (53%)          │ Классический: 60                │ │
│ │ • Used: 60 (40%)            │ Спортивный: 40                  │ │
│ │ • Expired: 10 (7%)          │ Праздничный: 30                 │ │
│ │                             │ Минималистичный: 20             │ │
│ └─────────────────────────────┴─────────────────────────────────┘ │
│                                                                     │
│ ┌───────────────────────────────────────────────────────────────┐ │
│ │ 💰 ПОПУЛЯРНЫЕ НОМИНАЛЫ                                        │ │
│ │ ┌─────────────────────────────────────────────────────────┐  │ │
│ │ │ Номинал     │ Количество    │ Процент    │ Сумма       │  │ │
│ │ ├─────────────┼───────────────┼────────────┼─────────────┤  │ │
│ │ │ 5 000 ₽     │ 60            │ 40%        │ 300 000 ₽   │  │ │
│ │ │ 10 000 ₽    │ 40            │ 27%        │ 400 000 ₽   │  │ │
│ │ │ 3 000 ₽     │ 30            │ 20%        │ 90 000 ₽    │  │ │
│ │ │ 7 500 ₽     │ 20            │ 13%        │ 150 000 ₽   │  │ │
│ │ └─────────────┴───────────────┴────────────┴─────────────┘  │ │
│ └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│ [📥 Экспорт в Excel]  [🖨️ Печать отчета]                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Project Status Board

### ⏳ ЗАДАЧИ К ВЫПОЛНЕНИЮ

#### ЭТАП 1: Backend - API для админа ✅ **ЗАВЕРШЕНО** (05.12.2025)
- [x] 1.1. Создать API для получения списка сертификатов с фильтрами (`GET /api/certificates/admin/list`)
- [x] 1.2. Создать API для детальной информации (`GET /api/certificates/admin/certificate/:id`)
- [x] 1.3. Создать API для управления сертификатами (продление, редактирование, повторная отправка)
- [x] 1.4. Создать API для ручного создания сертификата (`POST /api/certificates/admin/create`)
- [x] 1.5. Расширить API статистики (`GET /api/certificates/admin/statistics`)

#### ЭТАП 2: Backend - Автоматическое сгорание ✅ **ЗАВЕРШЕНО**
- [x] 2.1. Создать cron-задачу для пометки просроченных сертификатов
- [x] 2.2. ~~Создать задачу для напоминания об истекающих сертификатах~~ (отменено)

#### ЭТАП 3: Frontend - Интерфейс админ-панели
- [ ] 3.1. Создать дизайн вкладки "Сертификаты"
- [ ] 3.2. Реализовать функционал фильтрации и поиска
- [ ] 3.3. Реализовать модальное окно детальной информации
- [ ] 3.4. Реализовать формы управления
- [ ] 3.5. Реализовать форму ручного создания сертификата
- [ ] 3.6. Реализовать страницу статистики

#### ЭТАП 4: Тестирование
- [ ] 4.1. Функциональное тестирование API
- [ ] 4.2. Тестирование автоматических задач
- [ ] 4.3. Тестирование UI

### ✅ ВЫПОЛНЕНО

#### ЭТАП 1: Backend - API для админа ✅ **ЗАВЕРШЕНО** (05.12.2025)
- [x] 1.1. **API для получения списка сертификатов с фильтрами**
  - **Endpoint:** `GET /api/certificates/admin/list`
  - **Файл:** `src/routes/certificates.js` (строки 584-784)
  - Фильтры: статус, поиск, даты, номинал, дизайн, истекающие скоро
  - Пагинация, сортировка по любому полю
  - Защита через `verifyToken`
- [x] 1.2. **API для детальной информации о сертификате**
  - **Endpoint:** `GET /api/certificates/admin/certificate/:id`
  - **Файл:** `src/routes/certificates.js` (строки 1113-1266)
  - Полная информация: покупатель, получатель, транзакции, история
  - Защита через `verifyToken`
- [x] 1.3. **API для управления сертификатами**
  - **Продление срока:** `PUT /api/certificates/admin/certificate/:id/extend`
  - **Редактирование:** `PUT /api/certificates/admin/certificate/:id/edit` (с перегенерацией JPG)
  - **Повторная отправка:** `POST /api/certificates/admin/certificate/:id/resend`
  - **Файл:** `src/routes/certificates.js` (строки 1268-1589)
  - Все операции защищены через `verifyToken`
- [x] 1.4. **API для ручного создания сертификата**
  - **Endpoint:** `POST /api/certificates/admin/create`
  - **Файл:** `src/routes/certificates.js` (строки 1592-1788)
  - Возможность создания без списания средств (`skip_payment`)
  - Обязательное поле `reason` для логирования
  - Автоматическая генерация JPG и отправка email
- [x] 1.5. **Расширенная статистика**
  - **Endpoint:** `GET /api/certificates/admin/statistics` (обновлен)
  - **Файл:** `src/routes/certificates.js` (строки 1019-1111)
  - Новые метрики:
    - `expiring_soon_count` - истекающие в течение 7 дней
    - `not_activated_30_days_count` - неактивированные старше 30 дней
    - `average_time_to_activation_days` - среднее время до активации
    - `conversion_rate` - процент активации
    - `sales_by_day` - продажи по дням
    - Расширенные данные по номиналам и дизайнам

#### ЭТАП 2: Backend - Автоматизация ✅ **ЗАВЕРШЕНО** (05.12.2025)
- [x] 2.1. **Создана cron-задача для автоматического сгорания сертификатов**
  - **Файл:** `src/services/scheduler.js` (строки 274-328)
  - **Расписание:** Каждый день в 00:00 (Екатеринбург)
  - **Логика:**
    - Находит все сертификаты со статусом `active`, у которых `expiry_date < NOW()`
    - Меняет статус: `active` → `expired`
    - Собирает статистику (количество, общая сумма)
    - Отправляет отчет администратору в Telegram
    - Защита от повторного запуска
    - Обработка ошибок с уведомлением
  - **Уведомление администратору:**
    - Количество истекших сертификатов
    - Общая сумма
    - Список первых 10 сертификатов
    - Время выполнения
  - **Тестирование:** Создан скрипт `scripts/test-certificate-expiration.js`
- [x] 2.2. ~~Напоминания об истекающих сертификатах~~ - **ОТМЕНЕНО**
  - Причина: Покупатель может расстроиться, если получатель не воспользовался подарком

---

## Current Status / Progress Tracking

**Режим:** ⚙️ **EXECUTOR** - Реализация интернет-эквайринга Точка Банк

**Статус:** ✅ **BACKEND РЕАЛИЗАЦИЯ ЗАВЕРШЕНА** (10.12.2025)

**Что сделано:**

**Подготовка:**
- ✅ Изучена текущая реализация системы сертификатов
- ✅ Проанализированы все API endpoints
- ✅ Найдены проблемы и недостатки
- ✅ Составлен детальный план улучшения
- ✅ Спроектирован интерфейс админ-панели

**ЭТАП 1: Backend API для админа - ЗАВЕРШЕН ✅**
- ✅ Создан API для получения списка сертификатов с фильтрами (`GET /admin/list`)
- ✅ Создан API для детальной информации (`GET /admin/certificate/:id`)
- ✅ Создан API для продления срока (`PUT /admin/certificate/:id/extend`)
- ✅ Создан API для редактирования (`PUT /admin/certificate/:id/edit`)
- ✅ Создан API для повторной отправки (`POST /admin/certificate/:id/resend`)
- ✅ Создан API для ручного создания (`POST /admin/create`)
- ✅ Расширен API статистики (`GET /admin/statistics`)

**ЭТАП 2: Backend - Автоматизация - ЗАВЕРШЕН ✅**
- ✅ Создана cron-задача для автоматического сгорания сертификатов
- ✅ Добавлены функции уведомления администратора
- ✅ Создан тестовый скрипт для проверки (`scripts/test-certificate-expiration.js`)
- ✅ Добавлена документация (`docs/certificate-expiration-automation.md`)

---

## 💳 ИНТЕГРАЦИЯ ТОЧКА БАНК ЭКВАЙРИНГ (10.12.2025)

### ✅ Что реализовано:

**1. Поддержка публичного ключа JWK:**
- Обновлен `tochkaProvider.js` с методом `normalizePublicKey()`
- Автоматическая конвертация JWK → PEM
- Поддержка RS256 подписи вебхуков

**2. Парсинг вебхуков acquiringInternetPayment:**
- Обновлен `parseWebhookData()` под формат Точка Банка
- Маппинг статусов: SUCCESS, FAILED, PENDING, REFUNDED
- Извлечение всех необходимых полей (webhookType, paymentMethod, customerCode)

**3. Строгая проверка подписи:**
- JWT (RS256) проверка с публичным ключом OpenAPI
- Отклонение вебхуков с невалидной подписью (400)
- Логирование неудачных попыток

**4. Идемпотентность обработки:**
- Таблица `webhook_logs` с уникальным индексом
- Защита от дублирования при 30 ретраях
- ON CONFLICT DO UPDATE для повторных вебхуков

**5. Детальное логирование:**
- Миграция `create_webhook_logs_table.sql`
- Запись каждого вебхука в БД
- Поля: provider, webhook_type, payment_id, order_id, status, signature_valid, processed, error_message
- Индексы для быстрого поиска

**6. Улучшенная обработка callback:**
- `src/routes/kuliga-payment.js` полностью переработан
- Детальные логи на каждом этапе
- Обновление статусов бронирований и транзакций
- Всегда HTTP 200 (кроме критических ошибок)

**7. Инструменты для работы:**
- `scripts/register-tochka-webhook.js` - регистрация вебхука в API
- `scripts/test-tochka-payment.js` - тестовое создание платежа
- `scripts/apply-webhook-logs-migration.js` - применение миграции
- `TOCHKA_SETUP_FINAL.md` - пошаговая инструкция для запуска

### 📋 Что нужно от пользователя:

1. **Обновить `.env`:**
   ```env
   TOCHKA_PUBLIC_KEY={"kty":"RSA","e":"AQAB","n":"rwm77av7GIttq-JF1itEgLCGEZW_zz16RlUQVYlLbJtyRSu61fCec_rroP6PxjXU2uLzUOaGaLgAPeUZAJrGuVp9nryKgbZceHckdHDYgJd9TsdJ1MYUsXaOb9joN9vmsCscBx1lwSlFQyNQsHUsrjuDk-opf6RCuazRQ9gkoDCX70HV8WBMFoVm-YWQKJHZEaIQxg_DU4gMFyKRkDGKsYKA0POL-UgWA1qkg6nHY5BOMKaqxbc5ky87muWB5nNk4mfmsckyFv9j1gBiXLKekA_y4UwG2o1pbOLpJS3bP_c95rm4M9ZBmGXqfOQhbjz8z-s9C11i-jmOQ2ByohS-ST3E5sqBzIsxxrxyQDTw--bZNhzpbciyYW4GfkkqyeYoOPd_84jPTBDKQXssvj8ZOj2XboS77tvEO1n1WlwUzh8HPCJod5_fEgSXuozpJtOggXBv0C2ps7yXlDZf-7Jar0UYc_NJEHJF-xShlqd6Q3sVL02PhSCM-ibn9DN9BKmD"}
   ```

2. **Освободить место на диске:**
   - Ошибка: `No space left on device`
   - Удалить старые backup/log файлы
   - Нужно минимум 100MB

3. **Создать таблицу webhook_logs:**
   ```bash
   node scripts/apply-webhook-logs-migration.js
   ```

4. **Перезапустить сервер:**
   ```bash
   pm2 restart gornostyle
   ```

5. **Зарегистрировать вебхук:**
   ```bash
   node scripts/register-tochka-webhook.js
   ```

6. **Протестировать:**
   ```bash
   node scripts/test-tochka-payment.js
   ```

### 🎯 Результат:

После выполнения инструкции:
- ✅ Платежи через Точка Банк работают
- ✅ СБП включено
- ✅ Вебхуки принимаются и обрабатываются
- ✅ Подпись проверяется (RS256)
- ✅ Все логируется в БД
- ✅ Бронирования автоматически подтверждаются
- ✅ Экономия на комиссиях 45% (с 2% до ~1.1%)

**Следующий этап:** ЭТАП 3 - Frontend интерфейс админ-панели (сертификаты)

**Ключевые находки:**
1. ❌ Нет автоматического сгорания сертификатов (нужна cron-задача)
2. ❌ Текущая функция `loadCertificates()` в admin.js обращается к несуществующему API
3. ❌ Отсутствуют API endpoints для управления сертификатами (отмена, продление, редактирование)
4. ❌ Нет мониторинга и аналитики

---

## Executor's Feedback or Assistance Requests

### Вопросы для пользователя:

**1. Приоритеты реализации:**
   - Какой этап выполнить в первую очередь?
   - Нужны ли все функции сразу или начать с базового мониторинга?

**2. Автоматическое сгорание сертификатов:**
   - Подтверждаете необходимость cron-задачи для автоматической пометки просроченных?
   - Нужно ли уведомление покупателю, если сертификат истек?

**3. Отмена сертификата:**
   - Всегда ли возвращать средства на кошелек при отмене?
   - Нужно ли хранить историю отмены (причина, кто отменил)?

**4. Ручное создание сертификата:**
   - Кому разрешено создавать сертификаты вручную? (только супер-админ или всем админам?)
   - Ограничить ли возможность создания без списания средств?

**5. Дизайн интерфейса:**
   - Устраивает ли предложенный макет страницы?
   - Нужны ли дополнительные фильтры/колонки?

---

## Lessons

_Будут добавляться по мере реализации_

---

## Next Steps

**Ожидается:**
1. Утверждение плана пользователем
2. Ответы на вопросы выше
3. Выбор приоритетного этапа для начала реализации

**Готов к реализации:**
- Все задачи расписаны детально
- API endpoints спроектированы
- Интерфейс спроектирован
- Можно начинать кодирование

---

**Время составления плана:** 05.12.2025
**Планировщик:** AI Assistant
**Статус:** ✅ Готов к обсуждению и утверждению

# 🌐 Проект: Интернет-эквайринг Точка Банк (Planner)

## Background and Motivation
- Цель: переключить платежи Kuliga Booking на Точка Банк с картами и СБП, получать подтверждения через вебхуки и снизить комиссию.
- Уже в коде:
  - `src/services/payment/providers/tochkaProvider.js`: initPayment, checkPaymentStatus, refund; проверка подписи вебхука через JWT с `TOCHKA_PUBLIC_KEY` (сейчас допускает отсутствие ключа); parseWebhookData пока общий.
  - `src/services/payment/paymentProvider.js`: фабрика, дефолт `tochka`, auto-detect провайдера по payload.
  - `src/routes/kuliga-payment.js` (`/callback`): принимает webhook, проверяет подпись, парсит данные, мапит статусы на бронирования/транзакции.
  - В `src/routes/kuliga-booking.js` провайдер по умолчанию `tochka`.
- Поддержка Точки: создать вебхук через PUT Create Webhook (`webhooksList = acquiringInternetPayment`, `url = наш callback`). При регистрации тестовые вебхуки, нужно HTTP 200; при не-200 ретраи 30 раз каждые 10 сек. Публичный ключ OpenAPI для валидации подписи из доки: https://developers.tochka.com/docs/tochka-api/opisanie-metodov/vebhuki и PUT метод: https://developers.tochka.com/docs/tochka-api/api/create-webhook-webhook-v-1-0-client-id-put

## Key Challenges and Analysis
1) Подпись вебхука:
   - `verifyWebhookSignature` сейчас пропускает без `TOCHKA_PUBLIC_KEY`; нужно строгая проверка JWT (RS256) из Authorization Bearer или поля token/jwt.
   - Нужен точный формат payload/claims acquiringInternetPayment.
2) Регистрация вебхука:
   - Нет вызова PUT Create Webhook; нужно знать `clientId` и базовый API host, хранить URL в env.
   - При регистрации надо принять тестовые вебхуки с 200.
3) Соответствие статусов:
   - В коде мапятся SUCCESS/FAILED/REFUNDED/CONFIRMED/REJECTED/CANCELED; нужно сопоставить с реальными статусами события acquiringInternetPayment.
4) Идемпотентность:
   - Обновление транзакции без защиты от повторных отправок (до 30 ретраев); нужен guard (processed_at/версия/повторная проверка статуса).
5) Логи/мониторинг:
   - Нет отдельного логирования входящих вебхуков и ошибок подписи.
6) Конфигурация:
   - Требуются env: `TOCHKA_PUBLIC_KEY` (PEM), `TOCHKA_API_KEY` (JWT), `TOCHKA_CLIENT_ID`, `TOCHKA_MERCHANT_ID`, `TOCHKA_CUSTOMER_CODE`, `PAYMENT_CALLBACK_URL` (публичный HTTPS), `PAYMENT_SUCCESS_URL`, `PAYMENT_FAIL_URL`, `TOCHKA_API_URL`, `TOCHKA_ENABLE_SBP`.
7) Тестирование:
   - Нет тестов/моков вебхука acquiringInternetPayment; надо прогнать позитив/негатив подписи.

## High-level Task Breakdown
- Задача A: Согласовать входные данные
  - Получить `clientId`, публичный ключ (PEM) OpenAPI, список статусов acquiringInternetPayment, финальный публичный `PAYMENT_CALLBACK_URL`.
  - Критерий: все параметры добавлены в локальный env/секреты; формат ключа проверен.
- Задача B: Регистрация вебхука (PUT Create Webhook)
  - Реализовать сервис/скрипт вызова PUT `/webhook/{clientId}/v1.0` с `webhooksList=["acquiringInternetPayment"]`, `url=PAYMENT_CALLBACK_URL`.
  - Критерий: ответ 200 на регистрацию; тестовые вебхуки доходят и принимаются (HTTP 200).
- Задача C: Прием вебхуков
  - `verifyWebhookSignature`: обязательная проверка JWT RS256, отказ при неверной подписи.
  - `parseWebhookData`: адаптировать под фактический payload acquiringInternetPayment; зафиксировать маппинг статусов → `completed/failed/refunded`.
  - Идемпотентность: защита от дублей (processed_at/проверка статуса перед обновлением).
  - Логирование входящих вебхуков/подписей/апдейтов.
  - Критерий: повторные вебхуки 200 без дублей; неверная подпись → 400; валидный вебхук обновляет транзакцию и бронирование корректно.
- Задача D: Тесты
  - Интеграционный тест мок-вебхука acquiringInternetPayment (валид/невалид подпись).
  - Проверка обновления записей БД через `/callback`.
  - Критерий: тесты зелёные; ручной прогон тестового вебхука из Точки — бронирование обновлено, ответ 200.

## Project Status Board
- [ ] Задача A: Собрать credentials и ключи
- [ ] Задача B: Регистрация вебхука Create Webhook
- [ ] Задача C: Подпись/парсинг/идемпотентность вебхуков
- [ ] Задача D: Тесты вебхуков (валид/невалид)

## Current Status / Progress Tracking (Executor)
- **Режим:** ⚙️ **EXECUTOR** - Исправление ошибок UNION в напоминаниях о тренировках ✅ **ЗАВЕРШЕНО**
- **Проблема 1:** Ошибка "each UNION query must have the same number of columns"
  - **Причина:** В запросах для тренировок Кулиги отсутствовала колонка `participant_birth_date`
  - **Решение:** Добавлена колонка `NULL as participant_birth_date` в оба запроса Кулиги
- **Проблема 2:** Ошибка "UNION types integer and character varying cannot be matched"
  - **Причина:** Несовместимые типы данных в колонках `duration` и `skill_level`
  - **Решение:** 
    - `duration` в Кулиге приведен к INTEGER: `(EXTRACT(...) / 60)::INTEGER`
    - `skill_level` везде приведен к TEXT: `ts.skill_level::TEXT` и `kgt.level::TEXT`
    - `group_name` в групповых Кулиги приведен к TEXT: `kgt.level::TEXT`
- **Файл:** `src/services/notification-service.js`
- **Скрипт для ручного запуска:** `node src/scripts/send-training-reminders.js [дата]`

## Executor's Feedback or Assistance Requests
- ✅ **Исправлена ошибка UNION в напоминаниях (10.12.2025):**
  - Добавлена недостающая колонка `participant_birth_date` в запросы Кулиги
  - Файл: `src/services/notification-service.js`
  - Скрипт для ручного запуска: `node src/scripts/send-training-reminders.js [дата]`
  - Для тестирования: `node src/scripts/send-training-reminders.js 2025-12-11`
- ✅ **Ранее решено (10.12.2025):**
  - Удален неотслеживаемый файл `scripts/register-tochka-webhook.js`
  - Выполнено переключение на тег v3.0.0 (commit df41827)
  - Сервер перезапущен через PM2

## Lessons
- TODO: фиксировать нюансы (JWT, статусы и т.п.).
