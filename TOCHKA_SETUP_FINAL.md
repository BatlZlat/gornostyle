# üöÄ –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–æ—á–∫–∞ –ë–∞–Ω–∫ –≠–∫–≤–∞–π—Ä–∏–Ω–≥

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### Backend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JWK –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ `tochkaProvider.js`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `parseWebhookData` –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç `acquiringInternetPayment`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–æ–≤ (RS256)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–≤ –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `webhook_logs`)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–µ–±—Ö—É–∫–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### –ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç —Ç–µ–±—è:

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å `.env` —Å –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º

–ó–∞–º–µ–Ω–∏ —Å—Ç—Ä–æ–∫—É `TOCHKA_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----` –Ω–∞:

```env
TOCHKA_PUBLIC_KEY={"kty":"RSA","e":"AQAB","n":"rwm77av7GIttq-JF1itEgLCGEZW_zz16RlUQVYlLbJtyRSu61fCec_rroP6PxjXU2uLzUOaGaLgAPeUZAJrGuVp9nryKgbZceHckdHDYgJd9TsdJ1MYUsXaOb9joN9vmsCscBx1lwSlFQyNQsHUsrjuDk-opf6RCuazRQ9gkoDCX70HV8WBMFoVm-YWQKJHZEaIQxg_DU4gMFyKRkDGKsYKA0POL-UgWA1qkg6nHY5BOMKaqxbc5ky87muWB5nNk4mfmsckyFv9j1gBiXLKekA_y4UwG2o1pbOLpJS3bP_c95rm4M9ZBmGXqfOQhbjz8z-s9C11i-jmOQ2ByohS-ST3E5sqBzIsxxrxyQDTw--bZNhzpbciyYW4GfkkqyeYoOPd_84jPTBDKQXssvj8ZOj2XboS77tvEO1n1WlwUzh8HPCJod5_fEgSXuozpJtOggXBv0C2ps7yXlDZf-7Jar0UYc_NJEHJF-xShlqd6Q3sVL02PhSCM-ibn9DN9BKmD"}
```

---

### –®–∞–≥ 2: –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ ‚ö†Ô∏è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ (`No space left on device`).

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
df -h

# –ù–∞–π—Ç–∏ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã
du -h --max-depth=1 /home/dan/Project/gornostyle | sort -h

# –í–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:
# - –°—Ç–∞—Ä—ã–µ backup-—Ñ–∞–π–ª—ã (*.backup, *.dump, *.sql)
# - –õ–æ–≥–∏ (server.log, schedule-cron.log)
# - –ö—ç—à node_modules (–µ—Å–ª–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π)

# –£–¥–∞–ª–∏ –Ω–µ–Ω—É–∂–Ω–æ–µ –∏ –æ—Å–≤–æ–±–æ–¥–∏ –º–∏–Ω–∏–º—É–º 100MB
```

---

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É webhook_logs –≤ –ë–î

–ü–æ—Å–ª–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞:

```bash
cd /home/dan/Project/gornostyle
node scripts/apply-webhook-logs-migration.js
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
üì¶ –ü—Ä–∏–º–µ–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏—é webhook_logs...
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è webhook_logs —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
‚úÖ –¢–∞–±–ª–∏—Ü–∞ webhook_logs —Å–æ–∑–¥–∞–Ω–∞
```

---

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å PM2
pm2 restart gornostyle

# –ò–ª–∏
pm2 restart all

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs gornostyle --lines 50
```

---

### –®–∞–≥ 5: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫ –≤ –¢–æ—á–∫–∞ –ë–∞–Ω–∫–µ

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `https://gornostyle72.ru/api/kuliga/payment/callback`

```bash
cd /home/dan/Project/gornostyle
node scripts/register-tochka-webhook.js
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:**
1. –°–∫—Ä–∏–ø—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç PUT –∑–∞–ø—Ä–æ—Å –≤ –¢–æ—á–∫–∞ –ë–∞–Ω–∫ API
2. –ë–∞–Ω–∫ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫ –Ω–∞ —Ç–≤–æ–π callback URL
3. –¢–≤–æ–π —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å HTTP 200
4. –ï—Å–ª–∏ –≤—Å–µ –û–ö ‚Äî –≤–µ–±—Ö—É–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚úÖ

**–í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏:**
- `400 Bad Request` ‚Äî –±–∞–Ω–∫ –Ω–µ —Å–º–æ–≥ –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ callback URL –∏–ª–∏ –ø–æ–ª—É—á–∏–ª –Ω–µ-200
- `401 Unauthorized` ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–π `TOCHKA_API_KEY` –∏–ª–∏ `TOCHKA_CLIENT_ID`

---

### –®–∞–≥ 6: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

```bash
cd /home/dan/Project/gornostyle
node scripts/test-tochka-payment.js
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:**
1. –°–æ–∑–¥–∞—Å—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –Ω–∞ 100‚ÇΩ
2. –°–∫—Ä–∏–ø—Ç –≤—ã–≤–µ–¥–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
3. –û—Ç–∫—Ä–æ–π —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –æ–ø–ª–∞—Ç–∏ (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É)
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤–µ–±—Ö—É–∫ –Ω–∞ —Ç–≤–æ–π callback
5. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª–æ—Å—å

---

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤–µ–±—Ö—É–∫–æ–≤

```sql
-- –í psql
SELECT * FROM webhook_logs ORDER BY created_at DESC LIMIT 10;
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ —Å:
- `provider = 'tochka'`
- `webhook_type = 'acquiringInternetPayment'`
- `signature_valid = true`
- `processed = true`

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ

### 1. –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç:
https://gornostyle72.ru/instruktor-po-gornym-lyzham-snoubordy-tyumen

### 2. –í—ã–±–µ—Ä–∏ –ª—é–±—É—é –≥—Ä—É–ø–ø–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É

### 3. –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### 4. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ–ø–ª–∞—Ç—ã:
- –í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞ –∏–ª–∏ –°–ë–ü)
- –ù–∞–∂–º–∏ "–û–ø–ª–∞—Ç–∏—Ç—å"
- –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¢–æ—á–∫–∞ –ë–∞–Ω–∫–∞
- –û–ø–ª–∞—Ç–∏

### 5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:
- –î–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `PAYMENT_SUCCESS_URL`
- –í –ë–î –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å `confirmed`
- –í `webhook_logs` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–∏—Å—å —Å `status = 'SUCCESS'`

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤:
```sql
-- –í—Å–µ –≤–µ–±—Ö—É–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT 
    id, 
    webhook_type, 
    payment_id, 
    order_id, 
    status, 
    amount,
    signature_valid,
    processed,
    created_at
FROM webhook_logs 
WHERE created_at > NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC;

-- –ù–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∏
SELECT * FROM webhook_logs 
WHERE processed = false 
ORDER BY created_at DESC;

-- –í–µ–±—Ö—É–∫–∏ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é
SELECT * FROM webhook_logs 
WHERE signature_valid = false 
ORDER BY created_at DESC;
```

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
```bash
# PM2
pm2 logs gornostyle --lines 100

# Grep –ø–æ –≤–µ–±—Ö—É–∫–∞–º
pm2 logs gornostyle | grep webhook

# Grep –ø–æ –æ—à–∏–±–∫–∞–º
pm2 logs gornostyle | grep "‚ùå"
```

---

## ‚ùó Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

**–ü—Ä–æ–≤–µ—Ä—å:**
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –≤–µ–±—Ö—É–∫: `node scripts/register-tochka-webhook.js`
2. –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ callback URL –∏–∑–≤–Ω–µ: `curl -X POST https://gornostyle72.ru/api/kuliga/payment/callback`
3. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: `pm2 logs gornostyle`

---

### –ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω–∞

**–ü—Ä–æ–≤–µ—Ä—å:**
1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –≤—Å—Ç–∞–≤–ª–µ–Ω `TOCHKA_PUBLIC_KEY` –≤ `.env`
2. –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `.env`
3. –õ–æ–≥–∏: `pm2 logs gornostyle | grep "–ø–æ–¥–ø–∏—Å—å"`

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞—Ç–µ–∂ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å:**
1. –í—Å–µ –ª–∏ credentials –≤ `.env` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ª–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –≤ –¢–æ—á–∫–∞ –ë–∞–Ω–∫–µ
3. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `node scripts/test-tochka-payment.js`

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —á–µ—Ä–µ–∑ –¢–æ—á–∫–∞ –ë–∞–Ω–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–∞–º–∏  
‚úÖ –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –°–ë–ü  
‚úÖ –í–µ–±—Ö—É–∫–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è  
‚úÖ –ü–æ–¥–ø–∏—Å—å –≤–µ–±—Ö—É–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è  
‚úÖ –í—Å–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –ë–î  
‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è  

---

## üìû –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

–ü–∏—à–∏ –≤ —á–∞—Ç, –µ—Å–ª–∏:
- –ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è
- –í–µ–±—Ö—É–∫–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
- –ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

–£–¥–∞—á–∏! üöÄ


