#!/usr/bin/env node

/**
 * Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
 * 
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:
 * 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°:
 *    node src/scripts/test-notifications.js
 * 
 * 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ:
 *    node src/scripts/test-notifications.js 2025-10-15
 * 
 * 3. Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (Ğ±ĞµĞ· Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸):
 *    node src/scripts/test-notifications.js --dry-run
 */

require('dotenv').config();
const notificationService = require('../services/notification-service');
const { pool } = require('../db');

async function testNotifications() {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('  Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    try {
        // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        let targetDate;
        const dryRun = process.argv.includes('--dry-run');

        if (process.argv[2] && !process.argv[2].startsWith('--')) {
            targetDate = new Date(process.argv[2]);
            console.log(`ğŸ“… Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°: ${targetDate.toISOString().split('T')[0]}`);
        } else {
            targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 1);
            console.log(`ğŸ“… Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°: Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° (${targetDate.toISOString().split('T')[0]})`);
        }

        if (dryRun) {
            console.log('ğŸ§ª Ğ Ğ•Ğ–Ğ˜Ğœ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ (Ğ±ĞµĞ· Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸)\n');
        }

        console.log('\n--- Ğ¨Ğ°Ğ³ 1: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº ---\n');
        const trainings = await notificationService.getTrainingsByDate(targetDate);

        if (trainings.length === 0) {
            console.log('âŒ ĞĞµÑ‚ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº Ğ½Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ');
            process.exit(0);
        }

        console.log(`âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ½Ğ° Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸: ${trainings.length}\n`);
        
        // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°Ñ…
        console.log('Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº:');
        trainings.forEach((training, index) => {
            console.log(`\n${index + 1}. ${training.start_time} - ${training.end_time}`);
            console.log(`   Ğ¢Ğ¸Ğ¿: ${training.training_type === 'group' ? 'Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ°Ñ' : 'Ğ˜Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ'}`);
            console.log(`   Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº: ${training.display_name}`);
            console.log(`   ĞšĞ»Ğ¸ĞµĞ½Ñ‚: ${training.client_name} (ID: ${training.client_id})`);
            console.log(`   Telegram ID: ${training.telegram_id || 'ĞĞ•Ğ¢'}`);
        });

        console.log('\n--- Ğ¨Ğ°Ğ³ 2: Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼ ---\n');
        const groupedByClient = notificationService.groupTrainingsByClient(trainings);
        const clientIds = Object.keys(groupedByClient);

        console.log(`âœ… Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²: ${clientIds.length}\n`);

        // Ğ’Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°Ğ¼
        clientIds.forEach((clientId, index) => {
            const clientData = groupedByClient[clientId];
            console.log(`${index + 1}. ĞšĞ»Ğ¸ĞµĞ½Ñ‚: ${clientData.client_name} (ID: ${clientId})`);
            console.log(`   Telegram ID: ${clientData.telegram_id}`);
            console.log(`   ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ñ€ĞµĞ½Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº: ${clientData.trainings.length}`);
            clientData.trainings.forEach((training, tIndex) => {
                console.log(`   ${tIndex + 1}) ${training.start_time} - ${training.display_name}`);
            });
            console.log('');
        });

        console.log('--- Ğ¨Ğ°Ğ³ 3: Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ---\n');

        for (const [clientId, clientData] of Object.entries(groupedByClient)) {
            console.log(`\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`);
            console.log(`â”‚ ĞšĞ»Ğ¸ĞµĞ½Ñ‚: ${clientData.client_name}`);
            console.log(`â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n`);
            
            const message = notificationService.formatNotificationMessage(clientData, targetDate);
            console.log(message);
            console.log('\n' + 'â”€'.repeat(60) + '\n');
        }

        if (!dryRun) {
            console.log('--- Ğ¨Ğ°Ğ³ 4: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ ---\n');
            console.log('ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ...\n');

            const stats = await notificationService.sendTrainingReminders(targetDate);

            console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('  Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`Ğ’ÑĞµĞ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²:     ${stats.total_clients}`);
            console.log(`Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: ${stats.sent}`);
            console.log(`ĞÑˆĞ¸Ğ±Ğ¾Ğº:             ${stats.failed}`);

            if (stats.errors.length > 0) {
                console.log('\nĞÑˆĞ¸Ğ±ĞºĞ¸:');
                stats.errors.forEach((error, index) => {
                    console.log(`  ${index + 1}. ${error.client_name} (ID: ${error.client_id})`);
                    console.log(`     ${error.error}`);
                });
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
        } else {
            console.log('--- Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ ---\n');
            console.log('ğŸ’¡ Ğ”Ğ»Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ±ĞµĞ· Ñ„Ğ»Ğ°Ğ³Ğ° --dry-run\n');
        }

        process.exit(0);

    } catch (error) {
        console.error('\nâŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ:', error);
        console.error('\nStack trace:', error.stack);
        process.exit(1);
    } finally {
        // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ‘Ğ”
        await pool.end();
    }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº
testNotifications();

