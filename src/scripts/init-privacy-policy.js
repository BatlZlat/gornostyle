/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
 * 
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 * node src/scripts/init-privacy-policy.js
 * 
 * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:
 * USER_NAME=batl-zlat
 * HOST=90.156.210.24
 * DATABASE=skisimulator
 * PASSWORD=Nemezida2324%)
 * PORT=5432
 */

const { Pool } = require('pg');

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
const pool = new Pool({
    host: '90.156.210.24',
    port: 5432,
    database: 'skisimulator',
    user: 'batl-zlat',
    password: 'Nemezida2324%)',
    ssl: false
});

/**
 * –°–æ–∑–¥–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
 */
async function initPrivacyPolicy() {
    const client = await pool.connect();
    try {
        await client.query('BEGIN');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞
        const existingResult = await client.query(
            `SELECT id, version FROM privacy_policies 
             WHERE is_active = true 
             ORDER BY effective_date DESC 
             LIMIT 1`
        );
        
        if (existingResult.rows.length > 0) {
            console.log(`‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: –≤–µ—Ä—Å–∏—è ${existingResult.rows[0].version}, ID: ${existingResult.rows[0].id}`);
            await client.query('COMMIT');
            return existingResult.rows[0];
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É
        // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ views/privacy-policy.ejs –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        const policyContent = `
–ì–æ—Ä–Ω–æ—Å—Ç–∞–π–ª72 - –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏

–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 11 —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥–æ–¥–∞

–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è
–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–¥–∞–ª–µ–µ ‚Äî ¬´–°–æ–≥–ª–∞—Å–∏–µ¬ª) –¥–∞–µ—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ –æ—Ç 27.07.2006 ‚Ññ 152-–§–ó ¬´–û –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª.

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π: –¢–µ–±—è–∫–∏–Ω –î–∞–Ω–∏–ª–∞ –Æ—Ä—å–µ–≤–∏—á
- –ò–ù–ù: 740416017714
- –ü–∞—Å–ø–æ—Ä—Ç: 7115 190305
- –î–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –¢—Ä–µ–Ω–µ—Ä, –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –¥—Ä.
- –ê–¥—Ä–µ—Å: 625048, –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥. –¢—é–º–µ–Ω—å, —Å. –Ø—Ä, —É–ª. –ò—Å—Ç–æ—á–Ω–∏–∫, 2–ê
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (912) 392-49-56
- Email: batl-zlat@yandex.ru

–¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏
2. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–∑–∞–ø–∏—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
3. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤–µ–¥–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π, –≤—ã–¥–∞—á–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
4. –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã)
5. –í–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: https://gornostyle72.ru/privacy-policy
        `.trim();
        
        const result = await client.query(
            `INSERT INTO privacy_policies (version, title, content, is_active, effective_date)
             VALUES ($1, $2, $3, $4, $5)
             RETURNING id, version`,
            [
                '1.0',
                '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
                policyContent,
                true,
                new Date('2025-09-11')
            ]
        );
        
        await client.query('COMMIT');
        
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏:`);
        console.log(`   –í–µ—Ä—Å–∏—è: ${result.rows[0].version}`);
        console.log(`   ID: ${result.rows[0].id}`);
        console.log(`   –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —Å–∏–ª—É: 2025-09-11`);
        
        return result.rows[0];
    } catch (error) {
        await client.query('ROLLBACK');
        throw error;
    } finally {
        client.release();
    }
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
 */
async function main() {
    try {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏...\n');
        
        const policy = await initPrivacyPolicy();
        
        console.log('\n‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
        process.exit(0);
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        process.exit(1);
    } finally {
        await pool.end();
    }
}

// –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
if (require.main === module) {
    main();
}

module.exports = { initPrivacyPolicy };

