# Инструкция по установке электронной подписи на Ubuntu 24.04

## Текущее состояние системы
- **ОС:** Ubuntu 24.04.2 LTS (noble)
- **КриптоПро CSP:** Не установлен
- **PC/SC библиотека:** Установлена (libpcsclite1)

---

## Шаг 1: Установка системных пакетов

Выполните следующие команды для установки необходимых пакетов:

```bash
sudo apt update
sudo apt install -y libccid pcscd pcsc-tools
sudo systemctl enable pcscd
sudo systemctl start pcscd
sudo systemctl status pcscd
```

**Примечание:** Пакет `libgost-astra` доступен только для Astra Linux. В Ubuntu он не требуется - КриптоПро CSP включает необходимые библиотеки.

**Проверка:** Сервис `pcscd` должен быть активен (active).

---

## Шаг 2: Скачивание и установка КриптоПро CSP

### 2.1. Скачивание КриптоПро CSP

1. Перейдите на официальный сайт КриптоПро: https://www.cryptopro.ru/products/csp/downloads
2. Зарегистрируйтесь (если необходимо)
3. Скачайте дистрибутив **КриптоПро CSP 5.0 для Linux (x64, deb)**
4. Сохраните файл в папку `~/Загрузки` или `~/Downloads`

### 2.2. Распаковка и установка

После скачивания выполните:

```bash
cd ~/Загрузки  # или cd ~/Downloads
tar zxvf linux-amd64_deb.tgz
cd linux-amd64_deb/
sudo ./install_gui.sh
```

**Важно:** В установщике отметьте следующие компоненты:
- ✅ Криптопровайдер КС1
- ✅ Графические диалоги
- ✅ Поддержка токенов и смарт-карт
- ✅ cptools, многоцелевое графическое приложение
- ✅ Библиотека PKCS #11 (для gosuslugi.ru)

---

## Шаг 3: Установка драйверов для токенов (если используете Рутокен)

### 3.1. Установка ifd-rutokens

```bash
# Скачайте пакет ifd-rutokens с официального сайта Рутокен
# Затем установите:
sudo dpkg -i ifd-rutokens_1.0.4_amd64.deb
```

### 3.2. Установка библиотеки rtPKCS11ecp

```bash
# Скачайте библиотеку rtPKCS11ecp для GNU/Linux DEB 64-bit с сайта Рутокен
# Затем установите:
sudo dpkg -i librtpkcs11ecp_2.3.2.0-1_amd64.deb
```

---

## Шаг 4: Установка браузерного плагина

1. Скачайте **КриптоПро ЭЦП Browser plug-in** с сайта КриптоПро
2. Следуйте инструкциям по установке для вашего браузера (Chrome/Firefox)

---

## Шаг 5: Установка корневого сертификата УЦ

1. Скачайте корневой сертификат удостоверяющего центра
2. Запустите cptools:

```bash
/opt/cprocsp/bin/amd64/cptools
```

3. В открывшемся окне:
   - Перейдите на вкладку **"Сертификаты"**
   - Нажмите **"Установить сертификаты"**
   - Выберите скачанный файл сертификата
   - Нажмите **"Открыть"**

---

## Шаг 6: Настройка доверенных узлов

1. Откройте в браузере файл:

```
file:///etc/opt/cprocsp/trusted_sites.html
```

2. Добавьте необходимые адреса сайтов (например, gosuslugi.ru)
3. Нажмите на плюсик для добавления

---

## Шаг 7: Проверка установки

### Проверка КриптоПро:

```bash
/opt/cprocsp/bin/amd64/cptools
```

Должно открыться графическое приложение.

### Проверка токенов:

```bash
pcsc_scan
```

Если токен подключен, он должен быть обнаружен.

---

## Полезные ссылки

- [Статья Контур о работе с ЭП на Linux](https://ca.kontur.ru/articles/54155-rabota_s_elektronnoj_podpisyu_na_linux)
- [Официальный сайт КриптоПро](https://www.cryptopro.ru/)
- [Сайт Рутокен](https://www.rutoken.ru/)

---

## Возможные проблемы и решения

### Проблема: Сервис pcscd не запускается

**Решение:**
```bash
sudo systemctl restart pcscd
sudo journalctl -u pcscd -n 50
```

### Проблема: Токен не определяется

**Решение:**
1. Проверьте подключение токена
2. Проверьте статус сервиса: `sudo systemctl status pcscd`
3. Перезапустите сервис: `sudo systemctl restart pcscd`
4. Проверьте права доступа: `lsusb` (должен видеть устройство)

### Проблема: Браузер не видит плагин

**Решение:**
1. Убедитесь, что плагин установлен для вашего браузера
2. Проверьте настройки браузера (разрешения для плагинов)
3. Перезапустите браузер

---

## Следующие шаги

После установки:
1. Вставьте токен/смарт-карту с электронной подписью
2. Проверьте работу через cptools
3. Протестируйте подписание документов на нужном сайте

