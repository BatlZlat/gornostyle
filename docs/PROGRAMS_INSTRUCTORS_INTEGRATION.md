# Интеграция программ с инструкторами: Как это работает

## Реализованное решение

### Основная концепция
**Программа** назначает инструкторов, которые могут проводить занятия по этой программе. Тренировки создаются только если у назначенного инструктора есть свободный слот на время программы.

### Как это работает

#### 1. Создание программы (администратор)
- Администратор создает программу с параметрами:
  - Название, описание
  - Вид спорта (лыжи/сноуборд/оба)
  - **Место проведения** (Кулига/Воронинские горки)
  - Дни недели, время слотов
  - Цена, количество участников и т.д.
  - **Важно:** Выбирает одного или нескольких инструкторов из списка

#### 2. Назначение инструкторов
- Администратор может выбрать несколько инструкторов для программы
- Система проверяет:
  - Инструктор активен (`is_active = TRUE`)
  - Инструктор работает в том же месте, что и программа (`location` совпадает)
  - Инструктор проводит тренировки по нужному виду спорта (совместимость)
- Все назначенные инструкторы сохраняются в таблице `kuliga_program_instructors`

#### 3. Отображение программы на лендинге
- Программа отображается с расписанием (дни недели + время)
- Для каждого будущего занятия (например, следующее воскресенье в 10:30):
  - Система проверяет назначенных инструкторов
  - Для каждого инструктора проверяет расписание (`kuliga_schedule_slots`)
  - Если у инструктора есть свободный слот на это время - программа доступна для записи
  - Если ни у одного инструктора нет свободного слота - занятие не отображается или отображается как "нет доступных слотов"

#### 4. Запись клиента на программу
Когда клиент хочет записаться на программу (например, на следующее воскресенье в 10:30):

1. **Система находит доступные слоты:**
   - Проверяет назначенных инструкторов программы
   - Ищет свободные слоты (`status = 'available'`) у этих инструкторов
   - Фильтрует по дате, времени и месту проведения

2. **Создание групповой тренировки:**
   - Если найден свободный слот - автоматически создается групповая тренировка (`kuliga_group_trainings`)
   - Тренировка привязывается к слоту инструктора
   - Статус слота меняется на `'group'`
   - Тренировка получает параметры из программы (цена, количество участников и т.д.)

3. **Бронирование:**
   - Клиент записывается на созданную групповую тренировку
   - Создается запись в `kuliga_bookings` со статусом `'pending'` или `'confirmed'`

#### 5. Если у инструктора нет свободного слота
- Программа не отображается как доступная для записи на эту дату/время
- Или отображается с предупреждением "нет доступных слотов"
- Инструктор может создать слот в своем расписании - тогда программа автоматически станет доступной

## Преимущества решения

✅ **Гибкость:** Инструктор сам управляет своим расписанием  
✅ **Без конфликтов:** Тренировка создается только при наличии свободного слота  
✅ **Несколько инструкторов:** Программа может проводиться разными инструкторами  
✅ **Автоматизация:** Клиент видит доступные занятия без ручной работы админа  

## Что нужно доделать

1. **Логика отображения программ на лендинге** - проверять доступные слоты назначенных инструкторов
2. **Логика записи на программу** - автоматически создавать групповую тренировку при наличии свободного слота
3. **Обработка случая, когда все слоты заняты** - корректное отображение или предупреждение

## Технические детали

### Таблицы БД
- `kuliga_programs` - программы
- `kuliga_program_instructors` - связь программ и инструкторов (many-to-many)
- `kuliga_instructors` - инструкторы
- `kuliga_schedule_slots` - расписание инструкторов
- `kuliga_group_trainings` - групповые тренировки (создаются автоматически)
- `kuliga_bookings` - бронирования клиентов

### Миграции
- `039_add_location_to_kuliga_programs.sql` - добавление поля `location` в программы
- `040_create_program_instructors_link.sql` - создание связи программ и инструкторов

