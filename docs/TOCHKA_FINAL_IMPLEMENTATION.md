# –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –¢–æ—á–∫–∞ –ë–∞–Ω–∫

**–î–∞—Ç–∞:** 15 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω—ã —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (customerCode –∏ merchantId)

**–§–∞–π–ª:** `src/services/payment/providers/tochkaProvider.js`

- ‚úÖ –í–∫–ª—é—á—ë–Ω `merchantId` –≤ –∑–∞–ø—Ä–æ—Å—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –æ—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):**
```env
TOCHKA_CUSTOMER_CODE=305448656  # Business account (–±—ã–ª–æ 300764882 - —Ñ–∏–∑–ª–∏—Ü–æ)
TOCHKA_MERCHANT_ID=200000000030280  # 15 —Å–∏–º–≤–æ–ª–æ–≤ (–±—ã–ª–æ 29280 - 5 —Å–∏–º–≤–æ–ª–æ–≤)
```

**–û—Ç–≤–µ—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏:**
- `customerCode` –¥–ª—è –ò–ü (Business): **305448656** (–Ω–µ —Ñ–∏–∑–ª–∏—Ü–∞)
- `merchantId` —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏: **200000000030280**
- –†–∞–∑—Ä–µ—à–µ–Ω–∏—è (`MakeAcquiringOperation`) —É–∂–µ –≤—ã–¥–∞–Ω—ã ‚úÖ
- `merchantId` –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω –ø—Ä–∏ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

---

### 2. –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–Ω—å—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–≤–∞–ª–æ—Å—å –î–û –æ–ø–ª–∞—Ç—ã, —á—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:** –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/routes/kuliga-booking.js`:

**–î–û:**
1. –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ—Ç (`status = 'booked'`)
2. –°–æ–∑–¥–∞—ë—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (`status = 'pending'`)
3. –°–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
4. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞—Ç—ë–∂
5. –ü—Ä–∏ webhook –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –Ω–∞ `confirmed`

**–ü–û–°–õ–ï:**
1. **–ù–ï** —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ—Ç (–æ—Å—Ç–∞—ë—Ç—Å—è `available`)
2. **–ù–ï** —Å–æ–∑–¥–∞—ë—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
3. –°–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å `booking_id = NULL`
4. –î–∞–Ω–Ω—ã–µ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `provider_raw_data` (JSON)
5. –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç—Å—è –ø–ª–∞—Ç—ë–∂ (`orderId = kuliga-tx-{transactionId}`)
6. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º webhook —Å–æ–∑–¥–∞—ë—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (`status = 'confirmed'`)

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `orderId` —Ç–µ–ø–µ—Ä—å `kuliga-tx-{transactionId}` (—Ä–∞–Ω—å—à–µ `kuliga-{bookingId}`)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç `bookingData` –≤ JSON-–ø–æ–ª–µ `provider_raw_data`
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—á–µ–≥–æ (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ)

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook

**–§–∞–π–ª:** `src/routes/kuliga-payment.js`

#### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook:

1. **–ü–∞—Ä—Å–∏–Ω–≥ `orderId`:**
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `transactionId` –∏–∑ `kuliga-tx-{transactionId}`
   
2. **–ü–æ–∏—Å–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ `transactionId`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `booking_id`

3. **–ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω –ò –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ:**
   - –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ `provider_raw_data.bookingData`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–∞
   - –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç—Å—è —Å–ª–æ—Ç (`status = 'booked'`)
   - –°–æ–∑–¥–∞—ë—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (`status = 'confirmed'`)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `booking_id` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É

4. **–ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω –ò –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ:**
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –≠—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö webhook (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

5. **–ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è:**
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `failed`
   - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è
   - –°–ª–æ—Ç –æ—Å—Ç–∞—ë—Ç—Å—è `available`

6. **–ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ (refund):**
   - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `refunded`
   - –°–ª–æ—Ç –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è (`status = 'available'`)

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏

### –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞:
- ‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ù–µ—Ç ¬´–∑–∞–≤–∏—Å—à–∏—Ö¬ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
- ‚úÖ –°–ª–æ—Ç –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –æ–ø–ª–∞—Ç—ã (—á–µ—Å—Ç–Ω–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è)

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
- ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ù–µ—Ç –ª–æ–∂–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- ‚úÖ –ü—Ä–æ—â–µ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤

### –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ `merchantId` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –ø–ª–∞—Ç–µ–∂–∏
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –≤—Ç–æ—Ä–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ (–¥–ª—è –±–æ—Ç–∞)
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

---

## üöÄ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ API –æ—Ç–≤–µ—Ç–∞—Ö

### `/api/kuliga/bookings` (POST)

**–†–∞–Ω—å—à–µ:**
```json
{
  "success": true,
  "bookingId": 123,
  "paymentUrl": "https://...",
  "qrCodeUrl": "..."
}
```

**–¢–µ–ø–µ—Ä—å:**
```json
{
  "success": true,
  "transactionId": 456,  // ‚ö†Ô∏è –í–º–µ—Å—Ç–æ bookingId
  "paymentUrl": "https://...",
  "qrCodeUrl": "..."
}
```

> **–í–∞–∂–Ω–æ:** Frontend –º–æ–∂–µ—Ç –Ω–µ –æ–∂–∏–¥–∞—Ç—å `transactionId` –≤–º–µ—Å—Ç–æ `bookingId`.  
> –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ `bookingId` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞.

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

### `kuliga_transactions` (–ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞):

```sql
id: 456
client_id: 789
booking_id: NULL  -- ‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
type: 'payment'
amount: 2700.00
status: 'pending'
description: '–ö—É–ª–∏–≥–∞: –ª—ã–∂–∏ 16.12.2025, 14:00'
payment_provider: 'tochka'
provider_payment_id: NULL  -- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ—Å–ª–µ webhook
provider_order_id: 'kuliga-tx-456'
provider_status: NULL
payment_method: 'card'
provider_raw_data: {
  "bookingData": {
    "client_id": 789,
    "instructor_id": 5,
    "slot_id": 123,
    "date": "2025-12-16",
    "start_time": "14:00:00",
    "participants_count": 1,
    "price_total": 2700,
    "location": "vorona",
    ...
  },
  "paymentData": { ... }  -- –î–æ–±–∞–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ initPayment
}
```

### `kuliga_transactions` (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ webhook):

```sql
id: 456
booking_id: 321  -- ‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
status: 'completed'
provider_payment_id: 'pay_abc123'
provider_status: 'SUCCESS'
provider_raw_data: { ... }  -- –°–æ–¥–µ—Ä–∂–∏—Ç bookingData –∏ webhook payload
```

### `kuliga_bookings` (—Å–æ–∑–¥–∞–Ω–æ –ø—Ä–∏ webhook):

```sql
id: 321
client_id: 789
status: 'confirmed'  -- ‚úÖ –°—Ä–∞–∑—É confirmed, –Ω–µ pending
slot_id: 123
...
```

### `kuliga_schedule_slots` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏ webhook):

```sql
id: 123
status: 'booked'  -- ‚úÖ –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
...
```

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. –°–ª–æ—Ç –∑–∞–Ω—è—Ç –º–µ–∂–¥—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –æ–ø–ª–∞—Ç–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç A –Ω–∞—á–∞–ª –æ–ø–ª–∞—Ç—É, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª. –ö–ª–∏–µ–Ω—Ç B —É—Å–ø–µ–ª –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–ª–æ—Ç. –ö–ª–∏–µ–Ω—Ç A –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ–ø–ª–∞—Ç—É, –Ω–æ —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç.

**–†–µ—à–µ–Ω–∏–µ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- –ü—Ä–∏ webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `status` —Å–ª–æ—Ç–∞
- –ï—Å–ª–∏ —Å–ª–æ—Ç `!= 'available'`, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞—ë—Ç—Å—è
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –æ—à–∏–±–∫–∞
- –ö–ª–∏–µ–Ω—Ç—É –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏ (refund)

**TODO –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**
- –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refund —á–µ—Ä–µ–∑ API –±–∞–Ω–∫–∞ –ø—Ä–∏ –∑–∞–Ω—è—Ç–æ–º —Å–ª–æ—Ç–µ
- –ò–ª–∏ —É–≤–µ–¥–æ–º–ª—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞

### 2. Frontend –æ–∂–∏–¥–∞–µ—Ç `bookingId`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bookingId` –∏–∑ –æ—Ç–≤–µ—Ç–∞ `/api/kuliga/bookings` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `public/js/kuliga-booking.js` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `bookingId`
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `transactionId`
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –æ—Ç–≤–µ—Ç –æ–±–∞ –ø–æ–ª—è (–Ω–æ `bookingId: null` –¥–æ –æ–ø–ª–∞—Ç—ã)

### 3. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –¥–æ 30 —Ä–∞–∑ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞ 200.

**–†–µ—à–µ–Ω–∏–µ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):**
- –¢–∞–±–ª–∏—Ü–∞ `webhook_logs` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `booking_id` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ï—Å–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–æ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:8080/instruktor-po-gornym-lyzham-snoubordy-tyumen/booking?priceId=1&type=individual&price=2700&duration=60&participants=1
2. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É
3. –ù–∞–∂–∞—Ç—å "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å `booking_id = NULL`
   - ‚úÖ –í–æ–∑–≤—Ä–∞—â—ë–Ω `transactionId` –∏ `paymentUrl`
   - ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –±–∞–Ω–∫–∞
5. (–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) –û–ø–ª–∞—Ç–∏—Ç—å
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook:
   - ‚úÖ –°–æ–∑–¥–∞–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
   - ‚úÖ –°–ª–æ—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–≤–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞

1. –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂
2. (–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ) –û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–ª–∞—Ç—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `status = 'failed'`
   - ‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞–Ω–æ
   - ‚úÖ –°–ª–æ—Ç –æ—Å—Ç–∞–ª—Å—è `available`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–ª–æ—Ç –∑–∞–Ω—è—Ç –º–µ–∂–¥—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –æ–ø–ª–∞—Ç–æ–π

1. –ö–ª–∏–µ–Ω—Ç A –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂ –Ω–∞ —Å–ª–æ—Ç X
2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –±—Ä–æ–Ω–∏—Ä—É–µ—Ç —Å–ª–æ—Ç X –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ B
3. –ö–ª–∏–µ–Ω—Ç A –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - ‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞–Ω–æ (—Å–ª–æ—Ç –∑–∞–Ω—è—Ç)
   - ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –æ—à–∏–±–∫–æ–π
   - ‚ö†Ô∏è –ù—É–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ (TODO)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Frontend:**
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `public/js/kuliga-booking.js` –Ω–µ —Ç—Ä–µ–±—É–µ—Ç `bookingId` –∏–∑ –æ—Ç–≤–µ—Ç–∞
   - –ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `transactionId`

2. **–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Refund:**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –∑–∞–Ω—è—Ç–æ–º —Å–ª–æ—Ç–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –±–∞–Ω–∫–∞ –¥–ª—è refund

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç–µ:**
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ (–Ω–µ–±–æ–ª—å—à–∏–µ —Å—É–º–º—ã)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –æ—Ç –±–∞–Ω–∫–∞
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–æ–≥–∏ webhook
   - –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å ¬´–∑–∞–≤–∏—Å—à–∏–µ¬ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (pending –±–µ–∑ webhook)

### –î–ª—è –±—É–¥—É—â–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:

- –î–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Ç–æ—á–∫—É –¥–ª—è –±–æ—Ç–∞
- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å `merchantId` —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

---

## üì¶ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `src/services/payment/providers/tochkaProvider.js` - –≤–∫–ª—é—á—ë–Ω `merchantId`
2. ‚úÖ `src/routes/kuliga-booking.js` - –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
3. ‚úÖ `src/routes/kuliga-payment.js` - —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ webhook
4. ‚úÖ `.env` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã `TOCHKA_CUSTOMER_CODE` –∏ `TOCHKA_MERCHANT_ID`

---

## ‚úÖ –ò—Ç–æ–≥–æ

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  
**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:** –î–∞ (–ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π)  
**–¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º)  
**–†–∏—Å–∫–∏:** –°—Ä–µ–¥–Ω–∏–µ (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ–∂–∏–¥–∞—Ç—å `bookingId`)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ª–æ–∫–∞–ª–∏ —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º webhook
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `bookingId`
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–¥–µ —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ - –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π

