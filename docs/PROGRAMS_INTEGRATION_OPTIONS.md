# Варианты интеграции программ с расписанием инструкторов

## Текущая ситуация

1. **Инструкторы** создают свое расписание в личном кабинете (`kuliga_schedule_slots`)
   - Создают слоты на определенные даты и время
   - Клиенты записываются к инструктору на индивидуальные или групповые тренировки
   - Система автоматически обновляет статусы слотов

2. **Администратор** создает программы (`kuliga_programs`)
   - Программа описывает регулярную групповую тренировку (дни недели, время, место)
   - Пример: "Лыжники новички 14+", каждый воскресенье в 10:30
   - Программа не привязана к конкретному инструктору

## Проблема

Как связать программу с инструктором, чтобы:
- Не было конфликтов с расписанием инструкторов
- Клиенты могли записаться на программу
- Система автоматически создавала групповые тренировки по программе

## Варианты решения

### Вариант 1: Автоматическое создание групповых тренировок по расписанию программы

**Принцип:**
- Система автоматически создает групповые тренировки на основе программы каждую неделю
- Администратор назначает программе **приоритетного инструктора** (опционально)
- При создании тренировки система:
  1. Проверяет расписание инструктора на нужную дату/время
  2. Если у приоритетного инструктора есть свободный слот - использует его
  3. Если нет - ищет другого инструктора с тем же `location` и свободным слотом
  4. Если никого нет - создает тренировку без привязки к слоту (требует ручного назначения)

**Плюсы:**
- Автоматизация
- Гибкость (можно перераспределять между инструкторами)
- Минимум ручной работы

**Минусы:**
- Сложная логика автоматического назначения
- Возможны конфликты, если инструктор заблокировал слот в последний момент
- Нужна система уведомлений инструкторов

**Реализация:**
```sql
-- Добавить в kuliga_programs:
instructor_id INTEGER REFERENCES kuliga_instructors(id) -- приоритетный инструктор (nullable)
auto_create_trainings BOOLEAN DEFAULT TRUE -- автоматически создавать тренировки

-- Задача (cron job):
-- Каждую неделю (например, понедельник) создавать групповые тренировки на следующую неделю
-- Проверять расписание инструкторов и назначать тренировки
```

---

### Вариант 2: Ручное создание тренировок по программе через админ-панель

**Принцип:**
- Программа остается шаблоном
- Администратор вручную создает групповые тренировки через существующую функцию "Создать групповую тренировку"
- При создании выбирает программу из списка - система предзаполняет параметры
- Затем выбирает конкретный слот инструктора

**Плюсы:**
- Простота реализации
- Полный контроль администратора
- Нет автоматических конфликтов

**Минусы:**
- Ручная работа каждую неделю
- Можно забыть создать тренировку
- Дольше по времени

**Реализация:**
- Обновить модальное окно "Создать групповую тренировку"
- Добавить выбор программы - автозаполнение параметров
- Остальная логика уже есть

---

### Вариант 3: Гибридный подход (рекомендуется)

**Принцип:**
1. **Программа** имеет настройку:
   - `instructor_id` (приоритетный инструктор, опционально)
   - `auto_create_trainings` (автоматически создавать тренировки)
   - `creation_days_ahead` (за сколько дней создавать, по умолчанию 7)

2. **Автоматическое создание** (если включено):
   - Каждую неделю система проверяет программы с `auto_create_trainings = TRUE`
   - Для каждой программы создает тренировки на следующую неделю (или за N дней вперед)
   - Пытается найти свободный слот у приоритетного инструктора
   - Если нет - ищет других инструкторов с тем же `location`
   - Если никого нет - создает тренировку со статусом `pending_assignment` (требует ручного назначения)

3. **Ручное создание**:
   - Администратор всегда может создать тренировку вручную
   - Может выбрать программу для автозаполнения параметров
   - Может отключить автоматическое создание для конкретной программы

**Плюсы:**
- Гибкость (автоматизация + ручной контроль)
- Можно настроить для каждой программы отдельно
- Резервный вариант (ручное создание)

**Минусы:**
- Более сложная реализация
- Нужен cron job для автоматического создания

**Реализация:**
```sql
-- Обновить kuliga_programs:
ALTER TABLE kuliga_programs
ADD COLUMN instructor_id INTEGER REFERENCES kuliga_instructors(id),
ADD COLUMN auto_create_trainings BOOLEAN DEFAULT FALSE,
ADD COLUMN creation_days_ahead INTEGER DEFAULT 7,
ADD COLUMN last_auto_created_date DATE; -- последняя дата, для которой создавались тренировки

-- Добавить статус для групповых тренировок:
-- 'open' - открыта для записи (нормальное состояние)
-- 'pending_assignment' - требует назначения инструктора и слота
-- 'confirmed' - назначена, открыта для записи
```

---

### Вариант 4: Программа как "пул инструкторов" (самый гибкий)

**Принцип:**
- Программа может иметь несколько инструкторов (`kuliga_program_instructors`)
- При создании тренировки система выбирает инструктора с наименьшей загрузкой
- Или использует ротацию инструкторов

**Плюсы:**
- Распределение нагрузки между инструкторами
- Гибкость для программ с несколькими инструкторами

**Минусы:**
- Сложная логика выбора
- Может быть избыточно для начала

---

## Рекомендация

**Рекомендую Вариант 3 (гибридный подход)** с поэтапной реализацией:

### Этап 1: Базовая интеграция (быстро)
1. Добавить поле `instructor_id` в `kuliga_programs` (nullable)
2. Обновить форму создания программы - добавить выбор инструктора
3. Обновить форму "Создать групповую тренировку" - добавить выбор программы для автозаполнения
4. При выборе программы предзаполнять все параметры из программы

### Этап 2: Автоматическое создание (позже)
1. Добавить флаг `auto_create_trainings`
2. Создать cron job для автоматического создания тренировок
3. Реализовать логику поиска свободных слотов
4. Уведомления инструкторов о новых тренировках

### Этап 3: Улучшения (по необходимости)
1. Пул инструкторов для программы
2. Статистика по программам
3. Автоматическая отмена тренировок без записей

---

## Вопросы для обсуждения

1. **Нужна ли автоматизация сразу?** Или можно начать с ручного создания?
2. **Одна программа = один инструктор?** Или программа может проводиться разными инструкторами?
3. **Что делать, если у инструктора нет свободных слотов?** Создавать без привязки к слоту или искать другого инструктора?
4. **Как часто обновлять расписание?** Ежедневно? Еженедельно?

---

## Следующие шаги

После выбора варианта можно детализировать техническую реализацию и создать план разработки.

