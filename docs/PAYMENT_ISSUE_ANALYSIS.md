# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π (15 –¥–µ–∫–∞–±—Ä—è 2025)

## üîç –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è #24:**
- ‚úÖ –ü–ª–∞—Ç—ë–∂ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å —Å –∫–∞—Ä—Ç—ã (10‚ÇΩ)
- ‚úÖ `operationId`: `85dd4a42-b81a-423c-b64f-e5eebcf4645a`
- ‚úÖ –°—Ç–∞—Ç—É—Å: `CREATED`
- ‚ùå **Webhook –æ—Ç –±–∞–Ω–∫–∞ –ù–ï –ø—Ä–∏—à—ë–ª**
- ‚ùå **–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞–Ω–æ**

## ‚ùì –ü–æ—á–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å

### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π):
1. –ö–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂
2. –°–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è **–ë–ï–ó** –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
3. –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
4. **–ë–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook** —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ–ø–ª–∞—Ç—ã
5. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:
**–®–∞–≥ 4 –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è** ‚Äî –±–∞–Ω–∫ –ù–ï –æ—Ç–ø—Ä–∞–≤–∏–ª webhook —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–ø–ª–∞—Ç—ã.

## üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

### –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ webhook:
```bash
‚úÖ Webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:
{
  "webhooksList": ["acquiringInternetPayment"],
  "url": "https://gornostyle72.ru/api/kuliga/payment/callback"
}
```

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (09:18 –ú–°–ö):
```
‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫ –æ—Ç –±–∞–Ω–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ URL)
   Payload: {}
   User-Agent: python/3.11 aiohttp/3.12.4
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π webhook –¥–æ—Ö–æ–¥–∏—Ç
- ‚ùå –†–µ–∞–ª—å–Ω—ã–π webhook —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–ø–ª–∞—Ç—ã –ù–ï –ø—Ä–∏—à—ë–ª

## ü§î –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. –í–µ—Ä—Å–∏—è –∫–æ–¥–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞
- **–ù–∞ –ø—Ä–æ–¥–µ:** `v3.0.0.0.5`
- **–ù–∞ –ª–æ–∫–∞–ª–∏:** `v3.0.0.0.5-1-gcbfdff4` + uncommitted changes
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook –µ—â—ë –Ω–µ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–∞

### 2. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –ë–∞–Ω–∫ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å webhook —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5-30 –º–∏–Ω—É—Ç
- Webhook –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ 30 —Ä–∞–∑ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞ 200

### 3. –ë–∞–Ω–∫ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª webhook
- –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–∞–Ω–∫–∞
- Webhook –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

### 4. Webhook –ø—Ä–∏—à—ë–ª, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª—Å—è
- –ï—Å–ª–∏ –Ω–∞ –ø—Ä–æ–¥–µ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è, webhook –º–æ–∂–µ—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å—Å—è

## üí≥ –ü–æ—á–µ–º—É –Ω–µ –±—ã–ª–æ –≤—ã–±–æ—Ä–∞ –°–ë–ü/–ö–∞—Ä—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞:
–í –∑–∞–ø—Ä–æ—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
```json
"paymentMode": ["card"]  // ‚ùå –¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∞
```

### –ü—Ä–∏—á–∏–Ω–∞:
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `tochkaProvider.js`:
```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if (paymentMethod === 'card' || !paymentMethod) {
    paymentModes.push('card');
}
if (paymentMethod === 'sbp' && this.enableSBP) {
    paymentModes.push('sbp');
}
// –ï—Å–ª–∏ paymentMethod –Ω–µ —É–∫–∞–∑–∞–Ω - –¥–æ–±–∞–≤–ª—è–ª–∞—Å—å –¢–û–õ–¨–ö–û –∫–∞—Ä—Ç–∞
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```javascript
// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
if (!paymentMethod) {
    // –ù–µ —É–∫–∞–∑–∞–Ω —Å–ø–æ—Å–æ–± - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–∞
    paymentModes.push('card');
    if (this.enableSBP) {
        paymentModes.push('sbp');
    }
}
```

**–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `paymentMethod`:**
```json
"paymentMode": ["card", "sbp"]  // ‚úÖ –û–±–∞ —Å–ø–æ—Å–æ–±–∞
```

## üí∞ –ü—Ä–æ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Ä–∞—Å—á—ë—Ç–Ω–æ–º —Å—á—ë—Ç–µ

**‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!**

- –ë–∞–Ω–∫ –ø—Ä–æ–≤–æ–¥–∏—Ç –ø–ª–∞—Ç–µ–∂–∏ **1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ä–æ–∫ –¥–ª—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞: **T+1** –∏–ª–∏ **T+2**
- –í—ã —É–≤–∏–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á—ë—Ç–µ **–∑–∞–≤—Ç—Ä–∞ –∏–ª–∏ –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞**

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (—Å—Ä–æ—á–Ω–æ)
–¢–∞–∫ –∫–∞–∫ –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, –Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å, –Ω—É–∂–Ω–æ:
- –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ #24
- –ò–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ –±–∞–Ω–∫

### 2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞
–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É webhook
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫—É –°–ë–ü + –ö–∞—Ä—Ç–∞

**–§–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è:**
- `src/services/payment/providers/tochkaProvider.js` (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω paymentMode)
- `src/routes/kuliga-booking.js` (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
- `src/routes/kuliga-payment.js` (—Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ webhook)
- `.env` (–æ–±–Ω–æ–≤–ª–µ–Ω—ã `TOCHKA_CUSTOMER_CODE` –∏ `TOCHKA_MERCHANT_ID`)

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω—É–∂–Ω–æ:
- –°–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ (10‚ÇΩ)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –ø—Ä–∏—à—ë–ª
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–ª–æ—Å—å

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–µ–π
–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
- –°—Ç–∞—Ç—É—Å `pending` –∏–ª–∏ `CREATED`
- –°–æ–∑–¥–∞–Ω–æ > 30 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥
- `booking_id = NULL`
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

## üìä SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–µ–π

```sql
SELECT 
    id,
    amount,
    description,
    provider_payment_id,
    provider_order_id,
    status,
    provider_status,
    created_at,
    EXTRACT(EPOCH FROM (NOW() - created_at))/60 AS minutes_ago
FROM kuliga_transactions
WHERE booking_id IS NULL
  AND status IN ('pending')
  AND created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ #24:**
```
ID: 24
Amount: 10.00
Status: pending
Provider Status: CREATED
Minutes ago: ~45 –º–∏–Ω—É—Ç
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –°–µ–π—á–∞—Å (—Å—Ä–æ—á–Ω–æ):
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `paymentMode` (–°–ë–ü + –ö–∞—Ä—Ç–∞)
2. ‚è≥ –ù—É–∂–µ–Ω –¥–µ–ø–ª–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
3. ‚è≥ –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ #24

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
1. –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ (10‚ÇΩ)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook –≤ –ª–æ–≥–∞—Ö
3. –£–±–µ–¥–∏—Ç—å—Å—è –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–µ–π

### –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refund –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ "–∑–∞–≤–∏—Å—à–∏—Ö" –ø–ª–∞—Ç–µ–∂–∞—Ö
3. –î–∞—à–±–æ—Ä–¥ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üìù –†–µ–∑—é–º–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –æ—Ç –±–∞–Ω–∫–∞ –Ω–µ –ø—Ä–∏—à—ë–ª ‚Üí –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π webhook
2. –í—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –æ–ø–ª–∞—Ç—ã
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤–æ–º –ø–ª–∞—Ç–µ–∂–µ

**–î–µ–Ω—å–≥–∏:** –ü—Ä–∏–¥—É—Ç –Ω–∞ —Å—á—ë—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).

**–°–ë–ü:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞, —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –æ–±–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã.

