# Спецификация системы постоянного расписания

## Обзор

Система постоянного расписания позволяет администратору создавать шаблоны регулярных групповых тренировок, которые автоматически генерируются при создании ежемесячного расписания.

## Архитектура базы данных

### Таблица `recurring_training_templates`

```sql
CREATE TABLE recurring_training_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,  -- Название шаблона, например "Воскресная группа лыжников"
    day_of_week INTEGER NOT NULL CHECK (day_of_week BETWEEN 0 AND 6),  -- 0=ВС, 1=ПН, 2=ВТ, ..., 6=СБ
    start_time TIME NOT NULL,  -- Время начала тренировки (например, 11:00)
    simulator_id INTEGER REFERENCES simulators(id) NOT NULL,  -- Тренажер (1 или 2)
    trainer_id INTEGER REFERENCES trainers(id),  -- Тренер (опционально)
    group_id INTEGER REFERENCES groups(id) NOT NULL,  -- Группа
    skill_level INTEGER CHECK (skill_level BETWEEN 1 AND 10),  -- Уровень сложности
    max_participants INTEGER NOT NULL DEFAULT 4,  -- Максимальное количество участников
    equipment_type VARCHAR(20) DEFAULT 'ski',  -- ski или snowboard
    is_active BOOLEAN DEFAULT TRUE,  -- Активен ли шаблон
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индексы
CREATE INDEX idx_recurring_templates_active ON recurring_training_templates(is_active);
CREATE INDEX idx_recurring_templates_day_of_week ON recurring_training_templates(day_of_week);
CREATE INDEX idx_recurring_templates_simulator ON recurring_training_templates(simulator_id);

-- Триггер для обновления updated_at
CREATE TRIGGER update_recurring_templates_updated_at
    BEFORE UPDATE ON recurring_training_templates
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### Изменение таблицы `training_sessions`

```sql
-- Добавление поля для связи с шаблоном
ALTER TABLE training_sessions 
ADD COLUMN template_id INTEGER REFERENCES recurring_training_templates(id) ON DELETE SET NULL;

-- Индекс для быстрого поиска тренировок по шаблону
CREATE INDEX idx_training_sessions_template ON training_sessions(template_id);
```

**Важно**: При удалении шаблона `template_id` в тренировках становится `NULL`, но сами тренировки не удаляются автоматически. Удаление будет реализовано через API с явным запросом.

## Логика работы

### 1. Создание шаблона

**Пример**: Создать постоянную тренировку каждое воскресенье в 11:00 для лыжников.

```sql
INSERT INTO recurring_training_templates (
    name, 
    day_of_week, 
    start_time, 
    simulator_id, 
    trainer_id, 
    group_id, 
    skill_level, 
    max_participants, 
    equipment_type
) VALUES (
    'Воскресная группа лыжников',
    0,  -- Воскресенье
    '11:00',
    1,  -- Тренажер 1
    3,  -- Тренер с id=3
    5,  -- Группа с id=5
    3,  -- Средний уровень
    6,  -- До 6 человек
    'ski'
);
```

### 2. Автоматическая генерация тренировок

При запуске скрипта `create-next-month-schedule.js` (1-го числа каждого месяца):

1. **Загружаются активные шаблоны**:
   ```sql
   SELECT * FROM recurring_training_templates WHERE is_active = TRUE;
   ```

2. **Для каждого шаблона находятся подходящие даты**:
   ```javascript
   // Пример для воскресений (day_of_week = 0) в ноябре 2025
   // Результат: [2, 9, 16, 23, 30] ноября
   ```

3. **Создаются тренировки**:
   ```sql
   INSERT INTO training_sessions (
       simulator_id, 
       trainer_id, 
       group_id, 
       session_date, 
       start_time, 
       end_time, 
       duration,
       training_type, 
       max_participants, 
       skill_level, 
       price, 
       equipment_type,
       template_id  -- Связь с шаблоном!
   ) VALUES (
       1, 3, 5, '2025-11-02', '11:00', '12:00', 60, TRUE, 6, 3, 2500.00, 'ski', 1
   );
   ```

4. **Триггер автоматически помечает слоты**:
   - Слоты в `schedule` с `start_time` 11:00 и 11:30 помечаются `is_booked = TRUE`

### 3. Удаление шаблона

При удалении шаблона через API:

```javascript
// DELETE /api/recurring-templates/:id

// 1. Удаляем все БУДУЩИЕ тренировки, созданные из этого шаблона
DELETE FROM training_sessions 
WHERE template_id = $1 
AND session_date >= CURRENT_DATE;

// 2. Удаляем сам шаблон
DELETE FROM recurring_training_templates WHERE id = $1;
```

**Важно**: Прошедшие тренировки сохраняются для истории!

### 4. Деактивация шаблона

Вместо удаления можно деактивировать:

```sql
UPDATE recurring_training_templates 
SET is_active = FALSE 
WHERE id = $1;
```

При следующем создании расписания этот шаблон будет пропущен, но существующие тренировки останутся.

## API Endpoints

### GET /api/recurring-templates

Получить все шаблоны.

**Response**:
```json
[
  {
    "id": 1,
    "name": "Воскресная группа лыжников",
    "day_of_week": 0,
    "day_name": "Воскресенье",
    "start_time": "11:00:00",
    "simulator_id": 1,
    "simulator_name": "Тренажер 1",
    "trainer_id": 3,
    "trainer_name": "Иван Иванов",
    "group_id": 5,
    "group_name": "Взрослые начинающие",
    "skill_level": 3,
    "max_participants": 6,
    "equipment_type": "ski",
    "is_active": true,
    "created_at": "2025-10-01T10:00:00Z",
    "updated_trainings_count": 4  // Количество созданных будущих тренировок
  }
]
```

### POST /api/recurring-templates

Создать новый шаблон.

**Request**:
```json
{
  "name": "Суббота для сноубордистов",
  "day_of_week": 6,
  "start_time": "14:00",
  "simulator_id": 2,
  "trainer_id": 5,
  "group_id": 3,
  "skill_level": 5,
  "max_participants": 4,
  "equipment_type": "snowboard"
}
```

**Response**:
```json
{
  "id": 2,
  "message": "Шаблон успешно создан"
}
```

### PUT /api/recurring-templates/:id

Редактировать шаблон.

**Request**:
```json
{
  "name": "Обновленное название",
  "max_participants": 8
}
```

**Response**:
```json
{
  "message": "Шаблон успешно обновлен"
}
```

**Важно**: При редактировании шаблона существующие тренировки НЕ изменяются. Изменения влияют только на будущие создания.

### DELETE /api/recurring-templates/:id

Удалить шаблон и все будущие тренировки.

**Response**:
```json
{
  "message": "Шаблон удален",
  "deleted_trainings_count": 4
}
```

### PATCH /api/recurring-templates/:id/toggle

Активировать/деактивировать шаблон.

**Response**:
```json
{
  "message": "Шаблон деактивирован",
  "is_active": false
}
```

## UI/UX

### Страница управления расписанием

**URL**: `/recurring-schedule.html`

**Элементы интерфейса**:

1. **Список шаблонов** (таблица):
   - Название
   - День недели
   - Время
   - Тренажер
   - Группа
   - Тренер
   - Статус (активен/неактивен)
   - Действия (Редактировать, Удалить, Активировать/Деактивировать)

2. **Кнопка "Добавить шаблон"**:
   - Открывает модальное окно с формой

3. **Форма создания/редактирования**:
   - Название шаблона
   - День недели (dropdown: ПН, ВТ, СР, ЧТ, ПТ, СБ, ВС)
   - Время начала (time picker)
   - Тренажер (dropdown: загружается из API)
   - Группа (dropdown: загружается из API)
   - Тренер (dropdown: загружается из API, опционально)
   - Уровень сложности (1-10)
   - Макс. участников (число)
   - Тип снаряжения (ski/snowboard)

4. **Интеграция с админ-панелью**:
   - На странице "Расписание" в admin.html добавляется кнопка "Управление постоянным расписанием"

## Обработка edge cases

### 1. Конфликт расписания

**Проблема**: Шаблон пытается создать тренировку на уже занятый слот.

**Решение**: 
- Вариант А (рекомендуется): Пропустить с логированием
- При создании проверять доступность слотов
- Логировать конфликты для последующего анализа админом

```javascript
// Псевдокод
if (slotIsBooked) {
    console.error(`Конфликт: шаблон ${template.name} для ${date} ${time}`);
    continue; // Пропускаем эту дату
}
```

### 2. Удаленная группа/тренер

**Проблема**: В шаблоне указана группа или тренер, которые были удалены из БД.

**Решение**:
- Foreign key с `ON DELETE SET NULL` для trainer_id
- Foreign key с `ON DELETE CASCADE` для group_id (если группа удалена, шаблон тоже удаляется)
- При загрузке шаблонов проверять существование связанных сущностей

### 3. Праздничные дни

**Проблема**: Нужно ли пропускать создание тренировок в праздничные дни?

**Решение** (опционально):
- Добавить поле `skip_holidays BOOLEAN` в `recurring_training_templates`
- При создании проверять `is_holiday` в `schedule`

```sql
-- Опциональное расширение
ALTER TABLE recurring_training_templates 
ADD COLUMN skip_holidays BOOLEAN DEFAULT FALSE;
```

### 4. Изменение существующих тренировок

**Проблема**: Админ изменил шаблон. Обновлять ли созданные тренировки?

**Решение**: НЕТ.
- Созданные тренировки независимы
- Админ может вручную отредактировать конкретную тренировку
- Это дает гибкость для индивидуальных исключений

## Примеры использования

### Пример 1: Еженедельная тренировка

**Задача**: Создать тренировку каждый понедельник в 18:00 для продвинутых лыжников.

**Действия**:
1. Открыть "Управление постоянным расписанием"
2. Нажать "Добавить шаблон"
3. Заполнить:
   - Название: "Понедельник 18:00 - Продвинутые"
   - День недели: Понедельник
   - Время: 18:00
   - Тренажер: Тренажер 1
   - Группа: Продвинутые лыжники
   - Тренер: Александр Петров
   - Уровень: 7
   - Макс. участников: 4
   - Снаряжение: ski
4. Сохранить

**Результат**: При следующем создании месячного расписания автоматически создадутся 4-5 тренировок на все понедельники месяца.

### Пример 2: Выходная группа

**Задача**: Субботние и воскресные тренировки для детей.

**Действия**:
1. Создать 2 шаблона:
   - "Суббота 10:00 - Дети"
   - "Воскресенье 10:00 - Дети"
2. Указать одну группу "Детская группа"
3. Активировать оба шаблона

**Результат**: Каждый месяц создаются ~8-9 тренировок (4-5 суббот + 4-5 воскресений).

### Пример 3: Временное отключение

**Задача**: Тренер уходит в отпуск на месяц, но тренировки нужно будет возобновить.

**Действия**:
1. Открыть "Управление постоянным расписанием"
2. Найти шаблон с этим тренером
3. Нажать "Деактивировать"
4. После отпуска нажать "Активировать"

**Результат**: В следующем месяце тренировки не создадутся, а через месяц снова появятся.

## Тестирование

### Тестовые сценарии

1. **Создание шаблона**:
   - Создать шаблон с валидными данными
   - Попытаться создать шаблон с несуществующей группой
   - Попытаться создать шаблон с невалидным day_of_week (7)

2. **Автоматическая генерация**:
   - Создать шаблон на понедельник
   - Запустить скрипт создания расписания
   - Проверить, что созданы тренировки на все понедельники месяца
   - Проверить, что слоты помечены is_booked=true

3. **Удаление шаблона**:
   - Создать шаблон и сгенерировать тренировки
   - Удалить шаблон
   - Проверить, что будущие тренировки удалены
   - Проверить, что прошедшие тренировки сохранены
   - Проверить, что слоты освобождены (is_booked=false)

4. **Деактивация**:
   - Деактивировать шаблон
   - Запустить создание расписания
   - Проверить, что новые тренировки не создаются
   - Активировать шаблон
   - Запустить создание расписания
   - Проверить, что тренировки снова создаются

5. **Конфликты**:
   - Создать 2 шаблона на одно время и тренажер
   - Запустить создание расписания
   - Проверить, что создается только одна тренировка
   - Проверить логирование конфликта

## Производительность

### Оценка нагрузки

- **Создание расписания**: ~1 секунда на 10 шаблонов
- **Загрузка списка шаблонов**: < 100ms для 50 шаблонов
- **Удаление шаблона**: < 200ms (включая удаление тренировок)

### Оптимизация

- Индексы на `is_active`, `day_of_week`, `template_id`
- Batch-вставка тренировок при создании расписания
- Использование транзакций для атомарности операций

## Будущие улучшения

1. **Предпросмотр будущих тренировок**:
   - При создании/редактировании шаблона показывать список дат на следующий месяц

2. **Массовое редактирование**:
   - Возможность изменить несколько шаблонов одновременно

3. **Статистика**:
   - Количество созданных тренировок по каждому шаблону
   - Процент заполнения тренировок

4. **Экспорт/импорт**:
   - Сохранение шаблонов в JSON
   - Восстановление из бэкапа

5. **Уведомления**:
   - Отправка сообщения в админ-бот при создании тренировок
   - Уведомления о конфликтах

6. **Сложные паттерны**:
   - Каждая вторая неделя
   - Только первые 3 недели месяца
   - Исключения для конкретных дат

---

**Дата создания**: 06.10.2025  
**Версия**: 1.0  
**Автор**: AI Planner

