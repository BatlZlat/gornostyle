# üìä –°–¢–†–£–ö–¢–£–†–ê –¢–ê–ë–õ–ò–¶ –ü–†–ò –ó–ê–ü–ò–°–ò –ß–ï–†–ï–ó –°–ê–ô–¢

**–î–∞—Ç–∞:** 18.12.2025  
**–¶–µ–ª—å:** –û–±—ä—è—Å–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ —Å–∞–π—Ç

---

## üîÑ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –†–ê–ë–û–¢–´ –¢–ê–ë–õ–ò–¶

### –≠—Ç–∞–ø 1: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –Ω–∞ —Å–∞–π—Ç–µ
**–¢–∞–±–ª–∏—Ü—ã:** –ù–µ—Ç (–¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞)

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
**–¢–∞–±–ª–∏—Ü–∞:** `clients`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `email` (–µ—Å–ª–∏ –±—ã–ª –ø—É—Å—Ç–æ–π)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `birth_date` (–µ—Å–ª–∏ –±—ã–ª –≤—Ä–µ–º–µ–Ω–Ω—ã–º `1900-01-01`)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ `referral_code` –∏ –∫–æ—à–µ–ª—å–∫–∞
3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è `referral_code`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—à–µ–ª–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ `wallets`

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞
- `full_name` - –§–ò–û
- `phone` - —Ç–µ–ª–µ—Ñ–æ–Ω (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π)
- `email` - email (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)
- `referral_code` - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- `telegram_id` - ID –≤ Telegram (NULL –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å —Å–∞–π—Ç–∞)

**–§—É–Ω–∫—Ü–∏—è:** `upsertClient()` –≤ `src/routes/kuliga-booking.js`

---

### –≠—Ç–∞–ø 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–î–û –æ–ø–ª–∞—Ç—ã)
**–¢–∞–±–ª–∏—Ü–∞:** `kuliga_transactions`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ –∏ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
2. `booking_id = NULL` (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ!)
3. –î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `provider_raw_data` –∫–∞–∫ JSON:
   ```json
   {
     "bookingData": {
       "client_id": 91,
       "client_name": "–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫",
       "client_email": "test@example.com",
       "booking_type": "individual",
       "slot_id": 123,
       "instructor_id": 1,
       "date": "2025-12-19",
       "start_time": "14:00:00",
       "price_total": 2000.00,
       ...
     }
   }
   ```
4. –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è `paymentData` –≤ `provider_raw_data`

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `client_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
- `booking_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (NULL –¥–æ –æ–ø–ª–∞—Ç—ã)
- `type` - —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ('payment')
- `amount` - —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
- `status` - —Å—Ç–∞—Ç—É—Å ('pending' ‚Üí 'completed' –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
- `provider_raw_data` - JSON —Å `bookingData` –∏ `paymentData`
- `provider_order_id` - ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (—Ñ–æ—Ä–º–∞—Ç: `gornostyle72-winter-{transactionId}`)

**–í–∞–∂–Ω–æ:** –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ! –û–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

---

### –≠—Ç–∞–ø 4: –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–∞/–º–µ—Å—Ç–∞
**–¢–∞–±–ª–∏—Ü–∞:** `kuliga_schedule_slots` (–¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö) –∏–ª–∏ `kuliga_group_trainings` (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:
```sql
UPDATE kuliga_schedule_slots
SET status = 'hold',
    hold_until = NOW() + INTERVAL '5 minutes',
    hold_transaction_id = {transactionId}
WHERE id = {slot_id}
```
- –°–ª–æ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `hold` –Ω–∞ 5 –º–∏–Ω—É—Ç
- –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –∑–∞ 5 –º–∏–Ω—É—Ç - —Å–ª–æ—Ç –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è

#### –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:
```sql
UPDATE kuliga_group_trainings
SET current_participants = current_participants + {participants_count}
WHERE id = {group_training_id}
```
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `current_participants` –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ - —Å—á–µ—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `status` - —Å—Ç–∞—Ç—É—Å —Å–ª–æ—Ç–∞ ('available' ‚Üí 'hold' ‚Üí 'booked')
- `hold_until` - –≤—Ä–µ–º—è –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–ª–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- `hold_transaction_id` - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ —Å–ª–æ—Ç
- `current_participants` - —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö)

---

### –≠—Ç–∞–ø 5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
**–¢–∞–±–ª–∏—Ü—ã:** `kuliga_transactions` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `initPayment()` —É –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (Tinkoff/Tochka)
2. –ü–æ–ª—É—á–∞–µ–º `paymentURL` –∏ `paymentId`
3. –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
   ```sql
   UPDATE kuliga_transactions
   SET payment_provider = 'tinkoff',
       provider_payment_id = {paymentId},
       provider_order_id = 'gornostyle72-winter-{transactionId}',
       provider_status = 'PENDING',
       payment_method = 'card',
       provider_raw_data = {JSON —Å bookingData + paymentData}
   WHERE id = {transactionId}
   ```
4. `provider_raw_data` —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∏ `bookingData`, –∏ `paymentData`

**–í–∞–∂–Ω–æ:** `bookingData` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ!

---

### –≠—Ç–∞–ø 6: –û–ø–ª–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–º
**–¢–∞–±–ª–∏—Ü—ã:** –ù–µ—Ç (–ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)

–ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ `paymentURL` –∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ –±–∞–Ω–∫–∞.

---

### –≠—Ç–∞–ø 7: Webhook –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
**–¢–∞–±–ª–∏—Ü–∞:** `kuliga_transactions` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ë–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ `/api/kuliga/payment/callback`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—å webhook
3. –ù–∞—Ö–æ–¥–∏—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ `provider_order_id` (—Ñ–æ—Ä–º–∞—Ç: `gornostyle72-winter-{transactionId}`)
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   ```sql
   UPDATE kuliga_transactions
   SET status = 'completed',  -- –∏–ª–∏ 'failed', 'cancelled'
       provider_status = 'SUCCESS',  -- –∏–ª–∏ 'FAILED', 'REFUNDED'
       provider_payment_id = {paymentId},
       provider_raw_data = {–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JSON}
   WHERE id = {transactionId}
   ```

**–í–∞–∂–Ω–æ:** `provider_raw_data` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ `bookingData` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!

---

### –≠—Ç–∞–ø 8: –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã)
**–¢–∞–±–ª–∏—Ü–∞:** `kuliga_bookings`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ (`status = 'SUCCESS'`) –∏ `booking_id = NULL`:
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `bookingData` –∏–∑ `provider_raw_data`
3. –°–æ–∑–¥–∞–µ—Ç—Å—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
   ```sql
   INSERT INTO kuliga_bookings (
       client_id,
       booking_type,  -- 'individual' –∏–ª–∏ 'group'
       slot_id,  -- –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö
       group_training_id,  -- –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö
       instructor_id,
       date,
       start_time,
       end_time,
       sport_type,
       participants_count,
       participants_names,
       price_total,
       price_per_person,
       location,
       status  -- 'confirmed'
   ) VALUES (...)
   ```
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
   ```sql
   UPDATE kuliga_transactions
   SET booking_id = {bookingId}
   WHERE id = {transactionId}
   ```

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `client_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
- `booking_type` - —Ç–∏–ø ('individual' –∏–ª–∏ 'group')
- `slot_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–ª–æ—Ç (–¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö)
- `group_training_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä—É–ø–ø–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö)
- `status` - —Å—Ç–∞—Ç—É—Å ('confirmed' –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)
- `location` - –º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è ('vorona' –∏–ª–∏ 'kuliga')

---

### –≠—Ç–∞–ø 9: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–∞/–≥—Ä—É–ø–ø–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
**–¢–∞–±–ª–∏—Ü—ã:** `kuliga_schedule_slots` –∏–ª–∏ `kuliga_group_trainings`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

#### –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:
```sql
UPDATE kuliga_schedule_slots
SET status = 'booked',
    hold_until = NULL,
    hold_transaction_id = NULL
WHERE id = {slot_id}
```
- –°–ª–æ—Ç –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `booked`
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∏–º–∞–µ—Ç—Å—è

#### –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:
```sql
UPDATE kuliga_group_trainings
SET current_participants = current_participants + {participants_count}
WHERE id = {group_training_id}
```
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É–≤–µ–ª–∏—á–µ–Ω)

---

### –≠—Ç–∞–ø 10: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
**–¢–∞–±–ª–∏—Ü—ã:** –ù–µ—Ç (—Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π)

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. Email –∫–ª–∏–µ–Ω—Ç—É (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω email)
2. Telegram –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
3. Telegram –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É (–µ—Å–ª–∏ –µ—Å—Ç—å telegram_id)

---

## üìã –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ù–ê–ó–ù–ê–ß–ï–ù–ò–ô

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è |
|---------|-----------|-------------------|---------------|
| **`clients`** | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ | –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã | `id`, `full_name`, `phone`, `email`, `referral_code` |
| **`wallets`** | –ö–æ—à–µ–ª–µ–∫ –∫–ª–∏–µ–Ω—Ç–∞ | –°–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ | `client_id`, `wallet_number`, `balance` |
| **`kuliga_transactions`** | –ü–ª–∞—Ç–µ–∂ –∏ –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | –°–æ–∑–¥–∞–µ—Ç—Å—è –¥–æ –æ–ø–ª–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ | `id`, `client_id`, `booking_id`, `status`, `provider_raw_data` |
| **`kuliga_schedule_slots`** | –°–ª–æ—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ | –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –æ–ø–ª–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ | `id`, `instructor_id`, `date`, `start_time`, `status` |
| **`kuliga_group_trainings`** | –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ | –ë–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –º–µ—Å—Ç–∞ –¥–æ –æ–ø–ª–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ | `id`, `instructor_id`, `date`, `current_participants` |
| **`kuliga_bookings`** | –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ | –°–æ–∑–¥–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã | `id`, `client_id`, `booking_type`, `status` |
| **`kuliga_programs`** | –ü—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã | `id`, `name`, `price`, `location` |

---

## üîÑ –ü–û–õ–ù–´–ô FLOW –î–ê–ù–ù–´–•

```
1. –ö–ª–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –Ω–∞ —Å–∞–π—Ç–µ
   ‚Üì
2. POST /api/kuliga/bookings/individual (–∏–ª–∏ /group, /program)
   ‚Üì
3. upsertClient() ‚Üí clients (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
   ‚Üì
4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ ‚Üí wallets (–µ—Å–ª–∏ –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç)
   ‚Üì
5. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí kuliga_transactions
   - booking_id = NULL
   - status = 'pending'
   - provider_raw_data = { bookingData: {...} }
   ‚Üì
6. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–∞/–º–µ—Å—Ç–∞ ‚Üí kuliga_schedule_slots / kuliga_group_trainings
   - status = 'hold' (–¥–ª—è —Å–ª–æ—Ç–æ–≤)
   - current_participants++ (–¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö)
   ‚Üì
7. initPayment() ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ paymentURL
   ‚Üì
8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí kuliga_transactions
   - provider_payment_id = {paymentId}
   - provider_raw_data = { bookingData + paymentData }
   ‚Üì
9. –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ –±–∞–Ω–∫–∞
   ‚Üì
10. Webhook –æ—Ç –±–∞–Ω–∫–∞ ‚Üí POST /api/kuliga/payment/callback
    ‚Üì
11. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí kuliga_transactions
    - status = 'completed'
    - provider_status = 'SUCCESS'
    ‚Üì
12. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí kuliga_bookings
    - status = 'confirmed'
    ‚Üì
13. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí kuliga_transactions
    - booking_id = {bookingId}
    ‚Üì
14. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–∞/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Üí kuliga_schedule_slots / kuliga_group_trainings
    - status = 'booked' (–¥–ª—è —Å–ª–æ—Ç–æ–≤)
    ‚Üì
15. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Email, Telegram)
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´

### 1. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- –î–æ –æ–ø–ª–∞—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ù–ï–¢ –≤ —Ç–∞–±–ª–∏—Ü–µ `kuliga_bookings`
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `kuliga_transactions.provider_raw_data`

### 2. –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
- –°–ª–æ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç (`hold`)
- –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `current_participants`
- –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω–∏–º–∞–µ—Ç—Å—è

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ bookingData
- `bookingData` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `provider_raw_data` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `bookingData` –ù–ï —Ç–µ—Ä—è–µ—Ç—Å—è
- `bookingData` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

### 4. –§–æ—Ä–º–∞—Ç provider_order_id
- `gornostyle72-winter-{transactionId}` - –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
- `kuliga-tx-{transactionId}` - —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ webhook

### 5. –°—Ç–∞—Ç—É—Å—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `pending` - –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
- `completed` - —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω–∞
- `failed` - –æ–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞
- `cancelled` - –æ—Ç–º–µ–Ω–µ–Ω–∞/–≤–æ–∑–≤—Ä–∞—Ç

---

## üìù –ü–†–ò–ú–ï–†–´ SQL –ó–ê–ü–†–û–°–û–í

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–¥–æ –æ–ø–ª–∞—Ç—ã):
```sql
INSERT INTO kuliga_transactions (
    client_id, 
    booking_id,  -- NULL!
    type, 
    amount, 
    status,  -- 'pending'
    description,
    provider_raw_data  -- { bookingData: {...} }
) VALUES (...)
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ—Å–ª–µ webhook:
```sql
UPDATE kuliga_transactions
SET status = 'completed',
    provider_status = 'SUCCESS',
    booking_id = {bookingId},  -- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    provider_raw_data = {–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JSON}
WHERE id = {transactionId}
```

### –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã):
```sql
INSERT INTO kuliga_bookings (
    client_id,
    booking_type,
    slot_id,  -- –∏–ª–∏ group_training_id
    date,
    start_time,
    status  -- 'confirmed'
) VALUES (...)
```

---

**–í—ã–≤–æ–¥:** –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ —Å–∞–π—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 6 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ–ø–ª–∞—Ç–æ–π.

