# Функциональность "Детали тренировок в расписании"

## Описание
Реализована возможность просмотра детальной информации о тренировках (групповых и индивидуальных) на вкладке "Расписание" в админ-панели, а также удаление индивидуальных тренировок с возвратом средств.

## Реализованные компоненты

### Backend (API Endpoints)

#### 1. GET /api/individual-trainings/:id
**Файл:** `src/routes/individual-trainings.js`

**Описание:** Получение детальной информации об индивидуальной тренировке

**Возвращает:**
- Основную информацию о тренировке (дата, время, длительность, тип, цена)
- Информацию об участнике:
  - Для взрослых: ФИО, возраст, телефон
  - Для детей: ФИО ребенка, ФИО родителя, возраст ребенка, телефон родителя, уровень навыков

#### 2. DELETE /api/individual-trainings/:id
**Файл:** `src/routes/individual-trainings.js`

**Описание:** Удаление индивидуальной тренировки с автоматическим:
- Возвратом средств на кошелек клиента
- Созданием транзакции возврата
- Освобождением слотов в расписании
- Отправкой уведомлений клиенту и администратору через Telegram

**Возвращает:**
- Информацию об успешном удалении
- Сумму возврата
- Новый баланс клиента

### Frontend (Админ-панель)

#### 1. Кнопка "Подробнее" в расписании
**Файл:** `public/js/admin.js` (функция `loadSchedule`)

**Изменения:**
- Добавлена колонка "Действия" в таблицу расписания
- Каждая тренировка (групповая и индивидуальная) теперь имеет кнопку "Подробнее"
- Кнопка передает ID тренировки и флаг `is_individual`

#### 2. Функция viewScheduleDetails
**Файл:** `public/js/admin.js`

**Описание:** Универсальная функция для отображения деталей тренировки

**Функциональность:**
- Определяет тип тренировки (групповая/индивидуальная)
- Запрашивает соответствующий API endpoint
- Отображает модальное окно с деталями

**Для групповых тренировок показывает:**
- Дату, время, тренажер, группу, тренера, уровень, цену
- Список всех участников с возрастом, уровнем и контактными данными
- Только кнопку "Закрыть"

**Для индивидуальных тренировок показывает:**
- Дату, время, длительность, тренажер, тип (лыжи/сноуборд), с/без тренера, цену
- Информацию об участнике:
  - Если ребенок: ФИО участника, ФИО родителя, возраст, уровень, телефон родителя
  - Если взрослый: ФИО, возраст, телефон
- Кнопки "Удалить тренировку" и "Закрыть"

#### 3. Функция deleteIndividualTraining
**Файл:** `public/js/admin.js`

**Описание:** Удаление индивидуальной тренировки

**Функциональность:**
- Запрашивает подтверждение у администратора
- Отправляет DELETE запрос к API
- Закрывает модальное окно
- Показывает уведомление об успешном удалении с информацией о возврате средств
- Автоматически перезагружает расписание

## Интеграция

**Файл:** `src/app.js`
- Добавлен роутер `individualTrainingsRouter`
- Зарегистрирован маршрут `/api/individual-trainings` с проверкой токена

## Особенности реализации

### 1. Возврат средств
- Автоматический возврат стоимости тренировки на кошелек клиента
- Создание транзакции с подробным описанием (тип, участник, дата, время, длительность)
- Освобождение слотов расписания для возможности новых бронирований

### 2. Уведомления
**Клиенту отправляется:**
- Информация об отмене тренировки
- Данные участника и тренировки
- Сумма возврата
- Новый баланс кошелька

**Администратору отправляется:**
- Информация о том, что тренировка удалена
- ФИО клиента и контактные данные
- Данные участника и тренировки
- Сумма возврата и новый баланс клиента

### 3. Различие в отображении участников
Система корректно различает:
- Взрослых участников (отображается только ФИО клиента)
- Детей (отображается ФИО ребенка и ФИО родителя в отдельных колонках)

## Тестирование

### Сценарий 1: Просмотр деталей групповой тренировки
1. Открыть админ-панель
2. Перейти на вкладку "Расписание"
3. Найти групповую тренировку
4. Нажать кнопку "Подробнее"
5. Проверить отображение всех участников и деталей тренировки

### Сценарий 2: Просмотр деталей индивидуальной тренировки (взрослый)
1. Открыть админ-панель
2. Перейти на вкладку "Расписание"
3. Найти индивидуальную тренировку (взрослый клиент)
4. Нажать кнопку "Подробнее"
5. Проверить отображение данных клиента
6. Проверить наличие кнопки "Удалить тренировку"

### Сценарий 3: Просмотр деталей индивидуальной тренировки (ребенок)
1. Открыть админ-панель
2. Перейти на вкладку "Расписание"
3. Найти индивидуальную тренировку (ребенок)
4. Нажать кнопку "Подробнее"
5. Проверить отображение ФИО ребенка и ФИО родителя в отдельных колонках
6. Проверить наличие телефона родителя

### Сценарий 4: Удаление индивидуальной тренировки
1. Открыть детали индивидуальной тренировки
2. Нажать кнопку "Удалить тренировку"
3. Подтвердить удаление в диалоговом окне
4. Проверить:
   - Появление сообщения об успешном удалении с суммой возврата
   - Закрытие модального окна
   - Обновление расписания (тренировка исчезла)
   - Уведомление клиенту в Telegram
   - Уведомление администратору в Telegram
5. Проверить в базе данных:
   - Тренировка удалена из `individual_training_sessions`
   - Создана транзакция возврата в `transactions`
   - Баланс кошелька увеличен
   - Слоты освобождены в таблице `schedule`

## Безопасность
- Все API endpoints защищены middleware `verifyToken`
- Подтверждение удаления тренировки запрашивается у администратора
- Все операции выполняются в транзакциях БД (ROLLBACK при ошибках)

## База данных
Используются таблицы:
- `individual_training_sessions` - индивидуальные тренировки
- `clients` - клиенты
- `children` - дети
- `wallets` - кошельки
- `transactions` - транзакции
- `schedule` - слоты расписания
- `simulators` - тренажеры

## Заметки
- Функция корректно работает с UTC и локальным временем
- Возраст участника вычисляется динамически
- Уровень навыков отображается только если указан
- Все денежные операции выполняются с точностью до копеек

